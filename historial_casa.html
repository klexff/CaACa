<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Boletas ‚Äî Centro Educativo Integral Camino a Casa</title>

  <style>
    body {
      font-family: "Segoe UI", Arial;
      background: radial-gradient(circle at top, #faf8f2 0%, #eff6f2 50%, #e2ede7 100%);
      margin: 0;
      padding: 0;
      text-align: center;
      color: #23422f;
    }

    header {
      background: linear-gradient(90deg, #1f4e79, #2f8c4a);
      color: #fff;
      padding: 18px;
      box-shadow: 0 3px 8px rgba(0,0,0,0.12);
    }

    /* Ajuste del contenido */
    main {
      max-width: 1280px;
      margin: 20px auto;
      text-align: left;
      padding: 16px;
      box-sizing: border-box;
    }

    /* Tarjeta */
    .grupo-card {
      background: #ffffff;
      border-radius: 18px;
      padding: 20px;
      border-top: 6px solid #2f8c4a;
      box-shadow: 0 10px 22px rgba(0,0,0,0.12);
      margin-bottom: 24px;
      overflow-x: auto;
    }

    table {
      width: 100%;
      min-width: 1100px;
      border-collapse: collapse;
      margin-top: 14px;
      font-size: 14px;
    }

    th, td {
      border: 1px solid #b5c5bb;
      padding: 8px;
      text-align: center;
    }

    th {
      background: #1f4e79;
      color: white;
      font-weight: bold;
    }

    .alumno-row td:first-child {
      text-align: left;
      font-weight: 600;
    }

    .controls {
      display:flex;
      gap:12px;
      flex-wrap:wrap;
      margin-bottom:16px;
      align-items:center;
    }

    select, input[type="text"] {
      padding:8px;
      border-radius:8px;
      border:1px solid #ccc;
      font-size:14px;
    }

    .btn {
      background: #2f8c4a;
      color:white;
      padding:10px 16px;
      border:none;
      border-radius:12px;
      cursor:pointer;
      font-weight:600;
      transition:.25s;
    }

    .btn-blue { background:#1f4e79; }
    .btn-green { background:#3fa85c; }
    .btn-red { background:#c0392b; }

    .btn-boleta {
      background:#4fba6c;
      color:white;
      padding:6px 10px;
      border-radius:10px;
      border:none;
      cursor:pointer;
      font-size:0.85rem;
    }

    .att-field {
      width:60px;
      padding:6px;
      text-align:center;
      border-radius:6px;
      border:1px solid #ccc;
    }

    .small {
      font-size:12px;
      margin-top:12px;
      color:#333;
    }
  </style>
</head>
<body>

<header>
  <h1>üìò Historial Camino a Casa ‚Äî Generar Boletas</h1>
</header>

<main>
  <div class="controls">
    <label><b>Trimestre:</b></label>
    <select id="selectTrimestre"></select>

    <label><b>Grupo:</b></label>
    <select id="selectGrupo">
      <option value="">Seleccione...</option>
      <option value="1¬∞">1¬∞</option>
      <option value="2¬∞">2¬∞</option>
      <option value="3¬∞">3¬∞</option>
    </select>

    <button id="btnCargar" class="btn btn-blue">Cargar Grupo</button>
    <button id="btnImprimirGrupo" class="btn btn-green">Imprimir Boletas</button>
    <button onclick="location.href='index.html'" class="btn btn-red">Salir</button>
  </div>

  <div id="contenedor"></div>

  <p class="small">
    Edite las columnas de Inasistencias / Asistencias antes de generar la boleta.
  </p>
</main>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

<!-- ===========================
     üöÄ SCRIPT 100% FUNCIONAL
     =========================== -->
<script>
/* Firebase */
import("https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js").then(({ initializeApp }) => {
import("https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js").then(({ getDatabase, ref, get }) => {

const firebaseConfig = {
  apiKey: "AIzaSyDqty2eG_5VEi5NtU_HQzfZU_6FruMh66Q",
  authDomain: "camino-a-casa-87d65.firebaseapp.com",
  databaseURL: "https://camino-a-casa-87d65-default-rtdb.firebaseio.com",
  projectId: "camino-a-casa-87d65",
  storageBucket: "camino-a-casa-87d65.firebasestorage.app",
  messagingSenderId: "725645453280",
  appId: "1:725645453280:web:4cc41935020d1ae290ed85"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

const materiasPorGrupo = {
  "1¬∞": ["Espa√±ol 1","Ingl√©s 1","Danza 1","Matem√°ticas 1","Biolog√≠a 1","Geograf√≠a 1","Historia 1","Formaci√≥n C√≠vica y √âtica 1","Gastronom√≠a 1","Educaci√≥n F√≠sica 1","Habilidades Digitales 1"],
  "2¬∞": ["Espa√±ol 2","Ingl√©s 2","Danza 2","Matem√°ticas 2","F√≠sica 2","Historia 2","Formaci√≥n C√≠vica y √âtica 2","Gastronom√≠a 2","Educaci√≥n F√≠sica 2","Habilidades Digitales 2"],
  "3¬∞": ["Espa√±ol 3","Ingl√©s 3","Danza 3","Matem√°ticas 3","Qu√≠mica 3","Historia 3","Formaci√≥n C√≠vica y √âtica 3","Gastronom√≠a 3","Educaci√≥n F√≠sica 3","Habilidades Digitales 3"]
};

const selTri  = document.getElementById("selectTrimestre");
const selGrupo = document.getElementById("selectGrupo");
const contenedor = document.getElementById("contenedor");

/* ======================
   Cargar trimestres
   ====================== */
async function init() {
  const snap = await get(ref(db, "historial_casa"));
  selTri.innerHTML = "<option value=''>Seleccione...</option>";
  if (snap.exists()) {
    Object.keys(snap.val()).forEach(t => {
      const o = document.createElement("option");
      o.value = t;
      o.textContent = t;
      selTri.appendChild(o);
    });
  }
}
init();

/* ======================
      CARGAR GRUPO
   ====================== */
document.getElementById("btnCargar").onclick = async () => {
  const t = selTri.value;
  const g = selGrupo.value;

  if (!t || !g) return alert("Seleccione trimestre y grupo.");

  contenedor.innerHTML = "";
  const snap = await get(ref(db, `historial_casa/${t}/${g}`));
  if (!snap.exists()) {
    contenedor.innerHTML = `<div class="grupo-card">No hay datos.</div>`;
    return;
  }

  const datosGrupo = snap.val();
  const materias = materiasPorGrupo[g];

  // tomar lista de alumnos
  let alumnos = [];
  const primerMat = Object.keys(datosGrupo)[0];
  if (primerMat) alumnos = datosGrupo[primerMat].datos.map(x => x.alumno);

  let html = `<div class="grupo-card"><h3>Grupo ${g} ‚Äî ${t}</h3>`;
  html += `<table><thead><tr><th>Alumno</th>`;

  materias.forEach(m => html += `<th>${m}</th>`);

  html += `<th>Inasistencias</th><th>Asistencias</th><th>Boleta</th></tr></thead><tbody>`;

  alumnos.forEach((al, i) => {
    const encoded = encodeURIComponent(al);
    html += `<tr class="alumno-row"><td>${al}</td>`;

    materias.forEach(m => {
      const node = datosGrupo[m];
      const cal = node?.datos?.[i]?.calificacion ?? "-";
      html += `<td>${cal}</td>`;
    });

    html += `
      <td>
        <input class="att-field" data-al="${encoded}" data-t="i1" placeholder="I1">
        <input class="att-field" data-al="${encoded}" data-t="i2" placeholder="I2">
        <input class="att-field" data-al="${encoded}" data-t="i3" placeholder="I3">
      </td>

      <td>
        <input class="att-field" data-al="${encoded}" data-t="a1" placeholder="A1">
        <input class="att-field" data-al="${encoded}" data-t="a2" placeholder="A2">
        <input class="att-field" data-al="${encoded}" data-t="a3" placeholder="A3">
      </td>

      <td><button class="btn-boleta" onclick="generar('${encoded}','${g}','${t}')">Boleta</button></td>
    `;
  });

  html += "</tbody></table></div>";
  contenedor.innerHTML = html;
};

/* ================
   LEER ASISTENCIAS
   ================ */
function leerAsistencias(al){
  return {
    i1: document.querySelector(`input[data-al="${al}"][data-t="i1"]`)?.value || "",
    i2: document.querySelector(`input[data-al="${al}"][data-t="i2"]`)?.value || "",
    i3: document.querySelector(`input[data-al="${al}"][data-t="i3"]`)?.value || "",
    a1: document.querySelector(`input[data-al="${al}"][data-t="a1"]`)?.value || "",
    a2: document.querySelector(`input[data-al="${al}"][data-t="a2"]`)?.value || "",
    a3: document.querySelector(`input[data-al="${al}"][data-t="a3"]`)?.value || ""
  };
}

/* ===========================================================
   GENERAR PDF (LOGO GRANDE + PALETA PROFESIONAL + AJUSTES)
   =========================================================== */
/* ===========================================================
   GENERAR PDF ‚Äì OPCI√ìN B (PALETA VERDE + COLUMNA DE PROMEDIOS)
   =========================================================== */
window.generar = async (encoded, grupo, trimestreSel) => {

  const alumno = decodeURIComponent(encoded);
  const materias = materiasPorGrupo[grupo];
  const asist = leerAsistencias(encoded);

  const trimestres = ["1er Trimestre","2do Trimestre","3er Trimestre"];
  const datosTodas = {};

  for (const t of trimestres) {
    const snap = await get(ref(db, `historial_casa/${t}/${grupo}`));
    datosTodas[t] = snap.exists() ? snap.val() : {};
  }

  /* PDF */
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({ unit:"pt", format:"letter", orientation:"landscape" });

  const pageWidth = doc.internal.pageSize.getWidth();
  const margin = 36;

  /* LOGO desde ra√≠z */
  try {
    const resp = await fetch("logo2025.jpg");
    if (resp.ok) {
      const blob = await resp.blob();
      const reader = new FileReader();
      const dataUrl = await new Promise(r => { reader.onload = e => r(e.target.result); reader.readAsDataURL(blob); });

      doc.addImage(dataUrl, "JPEG", (pageWidth - 240) / 2, 20, 240, 110);
    }
  } catch(e){ console.warn(e); }

  /* Encabezado */
  doc.setFont("helvetica","bold");
  doc.setFontSize(14);
  doc.text("CICLO ESCOLAR", pageWidth - 200, 35);
  doc.setFontSize(18);
  doc.text("2025-2026", pageWidth - 200, 55);

  /* Datos alumno */
  doc.setFontSize(12);
  doc.setFont("helvetica","normal");
  doc.text(`NOMBRE DEL ALUMNO (A): ${alumno}`, margin, 150);
  doc.text(`GRADO: ${grupo}`, margin, 170);

  /* ===========================
      TABLA PRINCIPAL
     =========================== */

  const columns = [{ header:"Periodo", dataKey:"p" }];

  materias.forEach((m,i)=> columns.push({ header:m, dataKey:`m${i}` }));

  /* Columna nueva ‚Üí promedio del periodo */
  columns.push({ header:"Promedio", dataKey:"promPeriodo" });

  const filas = [];
  const ordenTri = ["1er Trimestre","2do Trimestre","3er Trimestre"];

  ordenTri.forEach((triName, r) => {
    const row = { p: `${r+1}¬∞` };
    const valoresParaProm = [];

    materias.forEach((m,i) => {
      const node = datosTodas[triName][m];
      let val = "-";

      if (node && node.datos) {
        const idx = node.datos.findIndex(x => x.alumno === alumno);
        if (idx >= 0) val = node.datos[idx].calificacion ?? "-";
      }

      if (!isNaN(Number(val))) valoresParaProm.push(Number(val));
      row[`m${i}`] = val;
    });

    row.promPeriodo = valoresParaProm.length ? 
                      (valoresParaProm.reduce((a,b)=>a+b)/valoresParaProm.length).toFixed(1) : "-";

    filas.push(row);
  });

  /* Promedio final */
  const promRow = { p:"Promedio" };
  let proms = [];

  materias.forEach((m,i)=>{
    const valores = [];
    ordenTri.forEach(tri => {
      const node = datosTodas[tri][m];
      if (node?.datos) {
        const idx = node.datos.findIndex(x => x.alumno === alumno);
        if (idx >= 0 && node.datos[idx].calificacion != null) {
          valores.push(Number(node.datos[idx].calificacion));
        }
      }
    });

    const p = valores.length === 3 ? (valores.reduce((a,b)=>a+b)/3).toFixed(1) : "-";
    promRow[`m${i}`] = p;

    if (!isNaN(Number(p))) proms.push(Number(p));
  });

  promRow.promPeriodo = proms.length ? (proms.reduce((a,b)=>a+b)/proms.length).toFixed(1) : "-";

  filas.push(promRow);

  /* ==========================================
      TABLA ESTILIZADA ‚Äì PALETA DEL LOGO
     ========================================== */

  doc.autoTable({
    startY: 200,
    head:[columns.map(c=>c.header)],
    body: filas.map(r => columns.map(c => r[c.dataKey] ?? "")),
    theme:"grid",
    headStyles:{ 
      fillColor:[31,78,121],   // azul del header
      textColor:255,
      fontStyle:"bold"
    },
    styles:{ 
      fontSize:10,
      cellPadding:5,
      lineColor:[47,140,74],   // verde del logo
      lineWidth:0.5
    },
    alternateRowStyles:{
      fillColor:[235,245,238]  // verde pastel suave
    }
  });

  /* Asistencias */
  const y = doc.lastAutoTable.finalY + 25;

  doc.text(`Inasistencias: I1=${asist.i1}  I2=${asist.i2}  I3=${asist.i3}`, margin, y);
  doc.text(`Asistencias:   A1=${asist.a1}  A2=${asist.a2}  A3=${asist.a3}`, margin, y + 18);

  /* Firmas con sombreado */
  const fy = y + 60;

  doc.setFillColor(235,245,238);
  doc.rect(margin, fy, 220, 60, "F");
  doc.text("Firma Tutor (1er Trimestre)", margin + 6, fy + 18);

  doc.rect(margin + 240, fy, 220, 60, "F");
  doc.text("Firma (2do Trimestre)", margin + 246, fy + 18);

  doc.rect(margin + 480, fy, 220, 60, "F");
  doc.text("Firma (3er Trimestre)", margin + 486, fy + 18);

  /* Guardar */
  doc.save(`Boleta_${grupo}_${alumno.replace(/[^a-z0-9]/gi,"_")}.pdf`);
};

/* ======================================
   IMPRIMIR TODO EL GRUPO
   ====================================== */
document.getElementById("btnImprimirGrupo").onclick = () => {
  const alumnos = document.querySelectorAll(".alumno-row");
  if (!alumnos.length) return alert("Cargue un grupo primero.");

  alumnos.forEach((row, i) => {
    const nombre = row.children[0].textContent.trim();
    const encoded = encodeURIComponent(nombre);
    setTimeout(() => generar(encoded, selGrupo.value, selTri.value), i * 600);
  });

  alert("Boletas del grupo iniciadas.");
};

});});
</script>

</body>
</html>
