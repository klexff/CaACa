<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Boletas — Centro Educativo Integral Camino a Casa</title>
  <style>
    body {
      font-family: "Segoe UI", Arial;
      background: radial-gradient(circle at top, #faf8f2 0%, #eff6f2 50%, #e2ede7 100%);
      margin: 0;
      padding: 0;
      text-align: center;
    }
    header {
      background: #1f4e79;
      color: #fff;
      padding: 16px;
      box-shadow: 0 3px 8px rgba(0,0,0,0.15);
    }
    header img {
      width: 70px;
      display: block;
      margin: 0 auto 4px;
    }
    header h1 {
      margin: 4px 0 0;
      font-size: 1.4rem;
    }
    main {
      max-width: 1100px;
      margin: 18px auto 40px;
      background:#ffffffb8;
      padding:16px 18px 24px;
      border-radius:12px;
      box-shadow:0 4px 12px rgba(0,0,0,0.10);
      text-align:left;
    }
    .filtros {
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
      justify-content:flex-start;
      margin-bottom:14px;
    }
    label {
      font-weight:600;
      color:#23422f;
    }
    select {
      padding:6px 8px;
      border-radius:6px;
      border:1px solid #ccc;
      font-family:inherit;
      min-width:140px;
    }
    .btn {
      border:none;
      border-radius:8px;
      padding:8px 12px;
      cursor:pointer;
      font-weight:600;
      color:#fff;
      transition:.15s ease;
    }
    .btn-blue { background:#1f4e79; }
    .btn-green{ background:#2f8c4a; }
    .btn-red  { background:#c0392b; }
    .btn:hover{
      transform:translateY(-1px);
      box-shadow:0 3px 8px rgba(0,0,0,0.18);
    }
    #contenedor {
      margin-top:14px;
    }
    .grupo-card {
      background:#fff;
      border-radius:10px;
      padding:12px;
      box-shadow:0 3px 10px rgba(0,0,0,0.08);
      border-top:4px solid #1f4e79;
    }
    .grupo-card h3 {
      margin:0 0 8px;
      color:#1f4e79;
    }
    table.tabla {
      width:100%;
      border-collapse:collapse;
      margin-top:6px;
      background:#fff;
    }
    table.tabla th,
    table.tabla td{
      border:1px solid #ddd;
      padding:6px;
      text-align:center;
      font-size:0.85rem;
    }
    table.tabla th{
      background:#1f4e79;
      color:#fff;
    }
    .alumno-row td:first-child{
      text-align:left;
      font-weight:600;
    }
    .att-field{
      width:30px;
      padding:2px 3px;
      margin:0 1px;
      font-size:0.75rem;
      text-align:center;
      border-radius:4px;
      border:1px solid #ccc;
    }
    .btn-boleta{
      background:#2f8c4a;
      color:#fff;
      border:none;
      border-radius:6px;
      padding:6px 10px;
      cursor:pointer;
      font-size:0.8rem;
      font-weight:600;
    }
    .btn-boleta:hover{
      box-shadow:0 2px 6px rgba(0,0,0,0.18);
    }
    .small{
      font-size:0.78rem;
      color:#555;
      margin-top:8px;
    }
  </style>
</head>

<body>
  <header>
    <img src="logo2025.jpg" alt="Logo">
    <h1>Boletas — Centro Educativo Integral Camino a Casa</h1>
  </header>

  <main>
    <div class="filtros">
      <label for="selectTrimestre">Trimestre:</label>
      <select id="selectTrimestre"></select>

      <label for="selectGrupo">Grupo:</label>
      <select id="selectGrupo">
        <option value="">Seleccione...</option>
        <option value="1°">1°</option>
        <option value="2°">2°</option>
        <option value="3°">3°</option>
      </select>

      <button id="btnCargar" class="btn btn-blue">Cargar grupo</button>
      <button id="btnImprimirGrupo" class="btn btn-green">Imprimir boletas</button>
      <button id="btnSalir" class="btn btn-red">Salir</button>
    </div>

    <div id="contenedor"></div>

    <p class="small">Edite las columnas de Inasistencias / Asistencias antes de generar la boleta.</p>
  </main>

  <!-- jsPDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

  <script>
    // Firebase con imports dinámicos
    import("https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js").then(({ initializeApp }) => {
    import("https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js").then(({ getDatabase, ref, get }) => {

      const firebaseConfig = {
        apiKey: "AIzaSyDqty2eG_5VEi5NtU_HQzfZU_6FruMh66Q",
        authDomain: "camino-a-casa-87d65.firebaseapp.com",
        databaseURL: "https://camino-a-casa-87d65-default-rtdb.firebaseio.com",
        projectId: "camino-a-casa-87d65",
        storageBucket: "camino-a-casa-87d65.firebasestorage.app",
        messagingSenderId: "725645453280",
        appId: "1:725645453280:web:4cc41935020d1ae290ed85"
      };

      const app = initializeApp(firebaseConfig);
      const db = getDatabase(app);

      /* Materias tal como en calificaciones_reales.html */
      const materiasPorGrupo = {
        "1°": [
          "Español 1","Inglés 1","Danza 1",
          "Matemáticas 1","Biología 1",
          "Geografía 1","Historia 1","Formación Cívica y Ética 1",
          "Gastronomía 1","Educación Física 1","Habilidades Digitales 1"
        ],
        "2°": [
          "Español 2","Inglés 2","Danza 2",
          "Matemáticas 2","Física 2",
          "Historia 2","Formación Cívica y Ética 2",
          "Gastronomía 2","Educación Física 2","Habilidades Digitales 2"
        ],
        "3°": [
          "Español 3","Inglés 3","Danza 3",
          "Matemáticas 3","Química 3",
          "Historia 3","Formación Cívica y Ética 3",
          "Gastronomía 3","Educación Física 3","Habilidades Digitales 3"
        ]
      };

      /* Columnas de la boleta oficial (como en la imagen) */
      const columnasBoleta = {
        "1°": [
          { campo:"Lenguaje", materia:"Español 1", etiqueta:"Español" },
          { campo:"Lenguaje", materia:"Lenguajes 1", etiqueta:"Lenguajes" },
          { campo:"Lenguaje", materia:"Artes 1", etiqueta:"Artes" },
          { campo:"Saberes y pensamientos científico", materia:"Matemáticas 1", etiqueta:"Matemáticas" },
          { campo:"Saberes y pensamientos científico", materia:"Biología 1", etiqueta:"Biología" },
          { campo:"Ética, naturaleza y sociedades", materia:"Geografía 1", etiqueta:"Geografía" },
          { campo:"Ética, naturaleza y sociedades", materia:"Historia 1", etiqueta:"Historia" },
          { campo:"Ética, naturaleza y sociedades", materia:"Formación Cívica y Ética 1", etiqueta:"Formación cívica y ética" },
          { campo:"De lo humano a lo comunitario", materia:"Gastronomía 1", etiqueta:"Gastronomía" },
          { campo:"De lo humano a lo comunitario", materia:"Educación Física 1", etiqueta:"Educación Física" }
        ],
        "2°": [
          { campo:"Lenguaje", materia:"Español 2", etiqueta:"Español" },
          { campo:"Lenguaje", materia:"Lenguajes 2", etiqueta:"Lenguajes" },
          { campo:"Lenguaje", materia:"Artes 2", etiqueta:"Artes" },
          { campo:"Saberes y pensamientos científico", materia:"Matemáticas 2", etiqueta:"Matemáticas" },
          { campo:"Saberes y pensamientos científico", materia:"Física 2", etiqueta:"Física" },
          { campo:"Ética, naturaleza y sociedades", materia:"Geografía 2", etiqueta:"Geografía" },
          { campo:"Ética, naturaleza y sociedades", materia:"Historia 2", etiqueta:"Historia" },
          { campo:"Ética, naturaleza y sociedades", materia:"Formación Cívica y Ética 2", etiqueta:"Formación cívica y ética" },
          { campo:"De lo humano a lo comunitario", materia:"Gastronomía 2", etiqueta:"Gastronomía" },
          { campo:"De lo humano a lo comunitario", materia:"Educación Física 2", etiqueta:"Educación Física" }
        ],
        "3°": [
          { campo:"Lenguaje", materia:"Español 3", etiqueta:"Español" },
          { campo:"Lenguaje", materia:"Lenguajes 3", etiqueta:"Lenguajes" },
          { campo:"Lenguaje", materia:"Artes 3", etiqueta:"Artes" },
          { campo:"Saberes y pensamientos científico", materia:"Matemáticas 3", etiqueta:"Matemáticas" },
          { campo:"Saberes y pensamientos científico", materia:"Química 3", etiqueta:"Química" },
          { campo:"Ética, naturaleza y sociedades", materia:"Geografía 3", etiqueta:"Geografía" },
          { campo:"Ética, naturaleza y sociedades", materia:"Historia 3", etiqueta:"Historia" },
          { campo:"Ética, naturaleza y sociedades", materia:"Formación Cívica y Ética 3", etiqueta:"Formación cívica y ética" },
          { campo:"De lo humano a lo comunitario", materia:"Gastronomía 3", etiqueta:"Gastronomía" },
          { campo:"De lo humano a lo comunitario", materia:"Educación Física 3", etiqueta:"Educación Física" }
        ]
      };

      const selTri  = document.getElementById("selectTrimestre");
      const selGrupo = document.getElementById("selectGrupo");
      const contenedor = document.getElementById("contenedor");
      const btnCargar = document.getElementById("btnCargar");
      const btnImprimirGrupo = document.getElementById("btnImprimirGrupo");

      let cicloEscolarNombre = "";
      let ultimoGrupoAlumnos = [];
      let ultimoGrupo = "";
      let ultimoTrimestre = "";

      function encodeKey(s){ return s.replace(/\./g,"_"); }

      async function cargarCicloEscolar() {
        const snap = await get(ref(db, "configuracion/cicloEscolarActivo"));
        if (snap.exists()) {
          const c = snap.val();
          cicloEscolarNombre = c.nombre || "";
        }
      }

      async function cargarTrimestres() {
        const snap = await get(ref(db, "calificaciones_reales"));
        selTri.innerHTML = "<option value=''>Seleccione...</option>";
        if (snap.exists()) {
          Object.keys(snap.val()).forEach(t => {
            const opt = document.createElement("option");
            opt.value = t;
            opt.textContent = t;
            selTri.appendChild(opt);
          });
        }
      }

      async function cargarGrupo() {
        const t = selTri.value;
        const g = selGrupo.value;

        if (!t || !g) {
          alert("Seleccione trimestre y grupo.");
          return;
        }

        const rutaGrupo = `calificaciones_reales/${encodeKey(t)}/${encodeKey(g)}`;
        const snap = await get(ref(db, rutaGrupo));
        const datosGrupo = snap.exists() ? snap.val() : {};

        // Leer alumnos desde la base "alumnos"
        const alumnosSnap = await get(ref(db, "alumnos"));
        let alumnos = [];
        if (alumnosSnap.exists()) {
          const all = alumnosSnap.val();
          Object.keys(all).forEach(id => {
            const a = all[id];
            if (a && a.grupo === g) alumnos.push(a.nombre);
          });
        }

        // Respaldo en caso de que aún no haya alumnos en la BD
        if (alumnos.length === 0) {
          const materiasK = Object.keys(datosGrupo || {});
          if (materiasK.length > 0) {
            const primerMat = materiasK[0];
            const arr = datosGrupo[primerMat]?.datos || [];
            alumnos = arr.map(x => x.alumno);
          }
        }

        alumnos.sort((a,b)=> a.localeCompare(b,"es"));

        const materias = materiasPorGrupo[g] || [];
        if (materias.length === 0) {
          contenedor.innerHTML = "<p>No hay materias configuradas para este grupo.</p>";
          return;
        }

        let html = `<div class="grupo-card"><h3>Grupo ${g} — ${t}</h3>`;
        html += `<table class="tabla"><thead><tr><th>Alumno</th>`;

        materias.forEach(m => { html += `<th>${m}</th>`; });

        html += `<th>Inasistencias</th><th>Asistencias</th><th>Boleta</th></tr></thead><tbody>`;

        alumnos.forEach(al => {
          const encoded = encodeURIComponent(al);
          html += `<tr class="alumno-row"><td>${al}</td>`;

          materias.forEach(m => {
            const nodo = datosGrupo[m];
            let cal = "-";
            if (nodo && Array.isArray(nodo.datos)) {
              const reg = nodo.datos.find(d => d.alumno === al);
              if (reg && reg.calificacion !== undefined && reg.calificacion !== null) {
                cal = reg.calificacion;
              }
            }
            html += `<td>${cal}</td>`;
          });

          html += `
            <td>
              <input class="att-field" data-al="${encoded}" data-t="i1" placeholder="I1">
              <input class="att-field" data-al="${encoded}" data-t="i2" placeholder="I2">
              <input class="att-field" data-al="${encoded}" data-t="i3" placeholder="I3">
            </td>
            <td>
              <input class="att-field" data-al="${encoded}" data-t="a1" placeholder="A1">
              <input class="att-field" data-al="${encoded}" data-t="a2" placeholder="A2">
              <input class="att-field" data-al="${encoded}" data-t="a3" placeholder="A3">
            </td>
            <td><button class="btn-boleta" onclick="generar('${encoded}','${g}','${t}')">Boleta</button></td>
          `;
        });

        html += "</tbody></table></div>";
        contenedor.innerHTML = html;

        ultimoGrupoAlumnos = alumnos;
        ultimoGrupo = g;
        ultimoTrimestre = t;
      }

      function leerAsistencias(encoded){
        return {
          i1: document.querySelector(`input[data-al='${encoded}'][data-t='i1']`)?.value || "",
          i2: document.querySelector(`input[data-al='${encoded}'][data-t='i2']`)?.value || "",
          i3: document.querySelector(`input[data-al='${encoded}'][data-t='i3']`)?.value || "",
          a1: document.querySelector(`input[data-al='${encoded}'][data-t='a1']`)?.value || "",
          a2: document.querySelector(`input[data-al='${encoded}'][data-t='a2']`)?.value || "",
          a3: document.querySelector(`input[data-al='${encoded}'][data-t='a3']`)?.value || ""
        };
      }

      // Construye una boleta en un documento jsPDF (no hace save)
      async function construirBoleta(doc, alumno, grupo, encodedAlumno){
        const columnas = columnasBoleta[grupo] || [];
        const trimestres = ["1er Trimestre","2do Trimestre","3er Trimestre"];

        // leer calificaciones de los 3 trimestres desde calificaciones_reales
        const califs = {};
        for (const tri of trimestres) {
          const ruta = `calificaciones_reales/${encodeKey(tri)}/${encodeKey(grupo)}`;
          const snap = await get(ref(db, ruta));
          const datos = snap.exists() ? snap.val() : {};
          califs[tri] = {};

          columnas.forEach(col => {
            const nodo = datos[col.materia];
            let valor = "";
            if (nodo && Array.isArray(nodo.datos)) {
              const reg = nodo.datos.find(d => d.alumno === alumno);
              if (reg && reg.calificacion !== undefined && reg.calificacion !== null) {
                valor = String(reg.calificacion);
              }
            }
            califs[tri][col.materia] = valor;
          });
        }

        // ---------- ENCABEZADO (logo + ciclo escolar más grande) ----------
        const margin = 40;
        const pageWidth = doc.internal.pageSize.getWidth();

        try {
          const img = new Image();
          img.src = "logo2025.jpg";
          await img.decode();
          // logo más grande
          doc.addImage(img,"JPEG",margin,22,110,80);
        } catch(e) { /* sin logo */ }

        doc.setFont("helvetica","bold");
        doc.setFontSize(18);
        doc.setTextColor(0,120,0);
        doc.text("CENTRO EDUCATIVO INTEGRAL", pageWidth/2, 38, {align:"center"});
        doc.text("CAMINO A CASA", pageWidth/2, 60, {align:"center"});

        // Ciclo escolar, un poco más grande
        doc.setFontSize(13);
        doc.setTextColor(0,0,0);
        const cx = pageWidth - margin - 140;
        doc.text("CICLO ESCOLAR", cx, 36);
        doc.setFont("helvetica","bold");
        doc.text(cicloEscolarNombre || "__________", cx, 52);

        doc.setFont("helvetica","normal");
        doc.setFontSize(11);
        doc.text(`NOMBRE DEL ALUMNO (A): ${alumno}`, margin, 110);
        doc.text(`GRADO: ${grupo}`, margin, 126);

        // ---------- TABLA PRINCIPAL ----------
        const head = [
          [
            { content:"Períodos de evaluación", rowSpan:2 },
            { content:"Lenguaje", colSpan:3 },
            { content:"Saberes y pensamientos científico", colSpan:2 },
            { content:"Ética, naturaleza y sociedades", colSpan:3 },
            { content:"De lo humano a lo comunitario", colSpan:2 },
            { content:"Promedio del bloque", rowSpan:2 }
          ],
          [
            { content:"Español" },
            { content:"Lenguajes" },
            { content:"Artes" },
            { content:"Matemáticas" },
            { content:"Biología / Física / Química" },
            { content:"Geografía" },
            { content:"Historia" },
            { content:"Formación cívica y ética" },
            { content:"Gastronomía" },
            { content:"Educación Física" }
          ]
        ];

        const body = [];
        const columnasMaterias = columnas.map(c => c.materia);

        trimestres.forEach((tri, idx) => {
          const fila = [];
          fila.push(`${idx+1}°`);
          const valoresParaProm = [];
          columnasMaterias.forEach(mat => {
            const v = califs[tri][mat] || "";
            fila.push(v || "-");
            const num = parseFloat(v);
            if (!isNaN(num)) valoresParaProm.push(num);
          });
          const prom = valoresParaProm.length
            ? (valoresParaProm.reduce((a,b)=>a+b,0)/valoresParaProm.length).toFixed(1)
            : "-";
          fila.push(prom);
          body.push(fila);
        });

        // ---------- PROMEDIO FINAL (solo si TODAS las calificaciones existen) ----------
        const filaFinal = [];
        filaFinal.push("Promedio final");
        const promsPorMateria = [];
        let materiasCompletas = 0;

        columnasMaterias.forEach(mat => {
          const vals = [];
          let completos = true;
          trimestres.forEach(tri => {
            const v = califs[tri][mat] || "";
            if (v === "") completos = false;
            const num = parseFloat(v);
            if (!isNaN(num)) vals.push(num);
          });

          let prom = "-";
          if (completos && vals.length === trimestres.length) {
            prom = (vals.reduce((a,b)=>a+b,0)/vals.length).toFixed(1);
            promsPorMateria.push(parseFloat(prom));
            materiasCompletas++;
          }
          filaFinal.push(prom);
        });

        let promFinalBloque = "-";
        if (materiasCompletas === columnasMaterias.length && promsPorMateria.length) {
          promFinalBloque = (promsPorMateria.reduce((a,b)=>a+b,0)/promsPorMateria.length).toFixed(1);
        }
        filaFinal.push(promFinalBloque);
        body.push(filaFinal);

        let startY = 150;
        const verdeSuave = [204, 238, 204]; // color más claro único para tópicos

        doc.autoTable({
          startY,
          head,
          body,
          theme:"grid",
          styles:{
            fontSize:9,
            halign:"center",
            cellPadding:3
          },
          headStyles:{
            fillColor: verdeSuave,
            textColor: [0,0,0],
            halign:"center",
            valign:"middle"
          },
          // Marcar divisiones de campos formativos
          didDrawCell: function(data){
            const docPDF = data.doc;
            if (data.section === 'head' || data.section === 'body') {
              const idx = data.column.index;
              // bordes más gruesos entre grupos: después de Español/Lenguajes/Artes, luego Mat/ByFQ, luego Geo/Hist/FCE, luego Gas/EF
              if ([4,6,9,11].includes(idx)) {
                const x = data.cell.x;
                const y = data.cell.y;
                const h = data.cell.height;
                docPDF.setLineWidth(1);
                docPDF.line(x, y, x, y + h);
                docPDF.setLineWidth(0.2);
              }
            }
          }
        });

        let y = doc.lastAutoTable.finalY + 18;

        const asist = leerAsistencias(encodedAlumno);

        // ---------- INASISTENCIAS / ASISTENCIAS ----------
        doc.autoTable({
          startY: y,
          margin: { left: margin },
          head: [[ "", "1er. Trimestre","2do. Trimestre","3er. Trimestre"]],
          body: [
            ["Inasistencias", asist.i1, asist.i2, asist.i3],
            ["Asistencias",  asist.a1, asist.a2, asist.a3]
          ],
          theme:"grid",
          styles:{fontSize:9, halign:"center", cellPadding:3},
          headStyles:{fillColor: verdeSuave, textColor:[0,0,0], halign:"center"}
        });

        y = doc.lastAutoTable.finalY + 12;

        // ---------- PROMEDIO FINAL DE GRADO ----------
        const promGrado = promFinalBloque !== "-" ? promFinalBloque : "-";
        doc.setFontSize(10);
        doc.setFont("helvetica","bold");
        doc.setFillColor(verdeSuave[0], verdeSuave[1], verdeSuave[2]);
        doc.rect(margin, y, 180, 26, "F");
        doc.setTextColor(0,0,0);
        doc.text("Promedio final de grado", margin+8, y+17);
        doc.rect(margin+180, y, 70, 26);
        doc.text(promGrado, margin+215, y+17, {align:"center"});

        // ---------- CUADRO DE FIRMAS ----------
        const firmaX = margin + 270;
        const firmaWidth = 360;
        const firmaHeight = 90;

        doc.setFillColor(verdeSuave[0], verdeSuave[1], verdeSuave[2]);
        doc.rect(firmaX, y, firmaWidth, 20, "F");
        doc.setFontSize(10);
        doc.setTextColor(0,0,0);
        doc.text("Firma de la madre o padre de familia o tutor o tutora", firmaX+8, y+13);

        const colWidth = firmaWidth / 3;
        const fy = y+20;
        doc.rect(firmaX, fy, colWidth, firmaHeight-20);
        doc.rect(firmaX+colWidth, fy, colWidth, firmaHeight-20);
        doc.rect(firmaX+2*colWidth, fy, colWidth, firmaHeight-20);

        doc.setFont("helvetica","normal");
        doc.text("1er. Trimestre", firmaX+colWidth/2, fy+16, {align:"center"});
        doc.text("2do. Trimestre", firmaX+colWidth+colWidth/2, fy+16, {align:"center"});
        doc.text("3er. Trimestre", firmaX+2*colWidth+colWidth/2, fy+16, {align:"center"});
      }

      // Boleta individual
      window.generar = async (encodedAlumno, grupo, trimestreSel) => {
        const alumno = decodeURIComponent(encodedAlumno);
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF({orientation:"landscape", unit:"pt", format:"letter"});
        await construirBoleta(doc, alumno, grupo, encodedAlumno);
        doc.save(`Boleta_${grupo}_${alumno.replace(/[^a-z0-9]/gi,"_")}.pdf`);
      };

      // Boletas de todo el grupo en un solo PDF
      async function imprimirBoletasGrupo(){
        if (!ultimoGrupo || !ultimoTrimestre || ultimoGrupoAlumnos.length === 0) {
          alert("Primero cargue un grupo con el botón 'Cargar grupo'.");
          return;
        }
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF({orientation:"landscape", unit:"pt", format:"letter"});

        for (let i=0; i<ultimoGrupoAlumnos.length; i++){
          const alumno = ultimoGrupoAlumnos[i];
          const encoded = encodeURIComponent(alumno);
          if (i>0) doc.addPage();
          await construirBoleta(doc, alumno, ultimoGrupo, encoded);
        }
        doc.save(`Boletas_${ultimoGrupo}_${ultimoTrimestre}.pdf`);
      }

      btnCargar.addEventListener("click", cargarGrupo);
      btnImprimirGrupo.addEventListener("click", imprimirBoletasGrupo);
      document.getElementById("btnSalir").addEventListener("click", ()=> location.href="index.html");

      (async function(){
        await cargarCicloEscolar();
        await cargarTrimestres();
      })();

    });});
  </script>

</body>
</html>
