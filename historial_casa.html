<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Boletas â€” Centro Educativo Integral Camino a Casa</title>

  <style>
    body {
      font-family: "Segoe UI", Arial;
      background: radial-gradient(circle at top, #faf8f2 0%, #eff6f2 50%, #e2ede7 100%);
      margin: 0;
      padding: 0;
      text-align: center;
      color: #23422f;
    }

    header {
      background: linear-gradient(90deg, #25619c, #2f8c4a);
      color: #fff;
      padding: 18px;
      box-shadow: 0 3px 8px rgba(0,0,0,0.12);
    }

    main {
      max-width: 1200px;
      margin: 20px auto;
      text-align: left;
      padding: 12px;
    }

    /* Tarjeta de Grupo */
    .grupo-card {
      background: #ffffff;
      border-radius: 18px;
      padding: 20px;
      border-top: 6px solid #2f8c4a;
      box-shadow: 0 10px 22px rgba(0,0,0,0.12);
      margin-bottom: 20px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 14px;
      font-size: 14px;
    }

    th, td {
      border: 1px solid #b5c5bb;
      padding: 8px;
      text-align: center;
    }

    th {
      background: #25619c;
      color: white;
      font-weight: bold;
    }

    .alumno-row td:first-child {
      text-align: left;
      font-weight: 600;
    }

    .controls {
      display:flex;
      gap:12px;
      flex-wrap:wrap;
      align-items:center;
      margin-bottom:16px;
    }

    select, input[type="text"] {
      padding:8px;
      border-radius:8px;
      border:1px solid #ccc;
      font-size:14px;
    }

    .btn {
      background: #2f8c4a;
      color: white;
      padding: 10px 16px;
      border: none;
      border-radius: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: .25s;
    }
    .btn-blue { background: #25619c; }
    .btn-red { background: #c0392b; }
    .btn-green { background: #3fa85c; }

    .btn-boleta {
      background: #4fba6c;
      color: white;
      padding: 6px 10px;
      border-radius: 10px;
      border: none;
      cursor: pointer;
      font-size: 0.85rem;
      transition: .18s;
    }

    .btn-boleta:hover {
      transform: scale(1.05);
      box-shadow: 0 6px 12px rgba(0,0,0,0.12);
    }

    .att-field {
      width: 64px;
      padding: 6px;
      border-radius: 6px;
      border: 1px solid #ccc;
      text-align: center;
    }

    .logo {
      display:block;
      margin: 6px auto 8px;
      width: 160px;
    }

    .small {
      font-size:12px;
      color:#444;
      margin-top:8px;
    }

    /* ensure last column (botÃ³n) not too small */
    .col-actions { min-width:120px; }

    @media (max-width:900px) {
      .grupo-card { padding:12px; }
      table { font-size:12px; }
    }
  </style>
</head>
<body>

<header>
  <h1>ðŸ“˜ Historial Camino a Casa â€” Generar Boletas</h1>
</header>

<main>
  <div class="controls">
    <label><b>Trimestre:</b></label>
    <select id="selectTrimestre"></select>

    <label><b>Grupo:</b></label>
    <select id="selectGrupo">
      <option value="">Seleccione...</option>
      <option value="1Â°">1Â°</option>
      <option value="2Â°">2Â°</option>
      <option value="3Â°">3Â°</option>
    </select>

    <button id="btnCargar" class="btn btn-blue">Cargar Grupo</button>
    <button id="btnImprimirGrupo" class="btn btn-green">Imprimir Boletas (por grupo)</button>
    <button class="btn btn-red" onclick="location.href='index.html'">Salir</button>
  </div>

  <div id="contenedor"></div>

  <p class="small">Edite Ãºnicamente las columnas de Inasistencias / Asistencias antes de generar la boleta individual o por grupo. Las calificaciones se leen desde <code>historial_casa</code> (Firebase).</p>
</main>

<!-- jsPDF y autoTable -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
  import { getDatabase, ref, get } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDqty2eG_5VEi5NtU_HQzfZU_6FruMh66Q",
    authDomain: "camino-a-casa-87d65.firebaseapp.com",
    databaseURL: "https://camino-a-casa-87d65-default-rtdb.firebaseio.com",
    projectId: "camino-a-casa-87d65",
    storageBucket: "camino-a-casa-87d65.firebasestorage.app",
    messagingSenderId: "725645453280",
    appId: "1:725645453280:web:4cc41935020d1ae290ed85"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  /* ===========================
     Materias: FORMATO A (EspaÃ±ol 1, MatemÃ¡ticas 1, ...)
     =========================== */
  const materiasPorGrupo = {
    "1Â°": [
      "EspaÃ±ol 1","InglÃ©s 1","Danza 1",
      "MatemÃ¡ticas 1","BiologÃ­a 1",
      "GeografÃ­a 1","Historia 1","FormaciÃ³n CÃ­vica y Ã‰tica 1",
      "GastronomÃ­a 1","EducaciÃ³n FÃ­sica 1","Habilidades Digitales 1"
    ],
    "2Â°": [
      "EspaÃ±ol 2","InglÃ©s 2","Danza 2",
      "MatemÃ¡ticas 2","FÃ­sica 2",
      "Historia 2","FormaciÃ³n CÃ­vica y Ã‰tica 2",
      "GastronomÃ­a 2","EducaciÃ³n FÃ­sica 2","Habilidades Digitales 2"
    ],
    "3Â°": [
      "EspaÃ±ol 3","InglÃ©s 3","Danza 3",
      "MatemÃ¡ticas 3","QuÃ­mica 3",
      "Historia 3","FormaciÃ³n CÃ­vica y Ã‰tica 3",
      "GastronomÃ­a 3","EducaciÃ³n FÃ­sica 3","Habilidades Digitales 3"
    ]
  };

  const selTri = document.getElementById("selectTrimestre");
  const selGrupo = document.getElementById("selectGrupo");
  const contenedor = document.getElementById("contenedor");
  const btnCargar = document.getElementById("btnCargar");
  const btnImprimirGrupo = document.getElementById("btnImprimirGrupo");

  // Cargar lista de trimestres disponibles en historial_casa
  async function init() {
    try {
      const snap = await get(ref(db, "historial_casa"));
      selTri.innerHTML = "<option value=''>Seleccione...</option>";
      if (!snap.exists()) return;
      const datos = snap.val();
      Object.keys(datos).forEach(t => {
        const opt = document.createElement("option");
        opt.value = t;
        opt.textContent = t;
        selTri.appendChild(opt);
      });
    } catch (err) {
      console.error("Error cargando trimestres:", err);
    }
  }

  // Cargar vista de grupo: tabla con alumnos x materias y campos de asistencia y botÃ³n individual
  btnCargar.addEventListener("click", async () => {
    const t = selTri.value;
    const g = selGrupo.value;
    contenedor.innerHTML = "";
    if (!t || !g) return alert("Seleccione trimestre y grupo.");

    // materias en el orden oficial
    const materias = materiasPorGrupo[g] || [];

    // leer datos en historial_casa para este trimestre y grupo
    try {
      const snap = await get(ref(db, `historial_casa/${t}/${g}`));
      if (!snap.exists()) {
        contenedor.innerHTML = "<div class='grupo-card'>No hay datos para este trimestre/grupo.</div>";
        return;
      }
      const datosGrupo = snap.val();

      // construir lista de alumnos tomando la primera materia existente (suponemos consistencia)
      let alumnos = [];
      const primerMat = Object.keys(datosGrupo)[0];
      if (primerMat) {
        const arr = datosGrupo[primerMat].datos || [];
        alumnos = arr.map(x => x.alumno);
      }

      // tarjeta
      const card = document.createElement("div");
      card.className = "grupo-card";

      // construir tabla
      let html = `<h3>Grupo ${g} â€” ${t}</h3>`;
      html += `<table><thead><tr><th>Alumno</th>`;
      materias.forEach(m => html += `<th>${m}</th>`);
      html += `<th>Inasistencias (1Â°,2Â°,3Â°)</th><th>Asistencias (1Â°,2Â°,3Â°)</th><th class="col-actions">Boleta</th></tr></thead><tbody>`;

      alumnos.forEach((al, idx) => {
        html += `<tr class="alumno-row"><td>${al}</td>`;
        materias.forEach(m => {
          const matNode = datosGrupo[m];
          let cal = "-";
          if (matNode && Array.isArray(matNode.datos) && matNode.datos[idx]) {
            cal = matNode.datos[idx].calificacion ?? "-";
          }
          html += `<td>${cal}</td>`;
        });

        // inputs de asistencia/inasistencia (editable)
        const encoded = encodeURIComponent(al);
        html += `<td>
          <div style="display:flex;gap:6px;justify-content:center">
            <input class="att-field" placeholder="I1" data-alumno="${encoded}" data-type="inasis1" value="">
            <input class="att-field" placeholder="I2" data-alumno="${encoded}" data-type="inasis2" value="">
            <input class="att-field" placeholder="I3" data-alumno="${encoded}" data-type="inasis3" value="">
          </div>
        </td>`;

        html += `<td>
          <div style="display:flex;gap:6px;justify-content:center">
            <input class="att-field" placeholder="A1" data-alumno="${encoded}" data-type="asis1" value="">
            <input class="att-field" placeholder="A2" data-alumno="${encoded}" data-type="asis2" value="">
            <input class="att-field" placeholder="A3" data-alumno="${encoded}" data-type="asis3" value="">
          </div>
        </td>`;

        // BotÃ³n individual para generar boleta de este alumno
        html += `<td><button class="btn-boleta" data-alumno="${encoded}">Generar Boleta</button></td>`;

        html += `</tr>`;
      });

      html += `</tbody></table>`;
      card.innerHTML = html;
      contenedor.appendChild(card);

      // asignar listeners al botÃ³n individual (delegaciÃ³n)
      card.querySelectorAll(".btn-boleta").forEach(b => {
        b.addEventListener("click", async (ev) => {
          const alumnoEncoded = ev.currentTarget.getAttribute("data-alumno");
          const alumno = decodeURIComponent(alumnoEncoded);
          // leemos asistencias del DOM para este alumno
          const asis = leerAsistencias(alumno);
          // leemos datos de los 3 trimestres necesarios
          const trimestres = ["1er Trimestre","2do Trimestre","3er Trimestre"];
          const datosTodas = {};
          for (const tri of trimestres) {
            const snapTri = await get(ref(db, `historial_casa/${tri}/${g}`));
            datosTodas[tri] = snapTri.exists() ? snapTri.val() : {};
          }
          // generar boleta (espera)
          await generarBoletaPDF(alumno, g, t, materias, datosTodas, asis);
          alert("Descarga de boleta iniciada para: " + alumno);
        });
      });

    } catch (err) {
      console.error(err);
      contenedor.innerHTML = "<div class='grupo-card'>Error al leer datos. Revisa consola.</div>";
    }
  });

  // leer inputs de asistencias para un alumno
  function leerAsistencias(alumno) {
    const encoded = encodeURIComponent(alumno);
    const fields = ["inasis1","inasis2","inasis3","asis1","asis2","asis3"];
    const out = {};
    fields.forEach(f => {
      const el = document.querySelector(`input[data-alumno="${encoded}"][data-type="${f}"]`);
      out[f] = el ? el.value.trim() : "";
    });
    return out;
  }

  // Generar boleta PDF individual con jsPDF + autoTable
  async function generarBoletaPDF(alumno, grupo, trimestreSeleccionado, materias, datosTodasTrimestres, asistenciasAlumnos) {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({ unit: 'pt', format: 'letter', orientation: 'landscape' });

    const margin = 36;
    const pageWidth = doc.internal.pageSize.getWidth();

    // LOGO centrado (usa archivo logo2025.jpg en la misma carpeta)
    try {
      const logoUrl = "logo2025.jpg";
      const resp = await fetch(logoUrl);
      if (resp.ok) {
        const blob = await resp.blob();
        const reader = new FileReader();
        const dataUrl = await new Promise(resolve => { reader.onload = e => resolve(e.target.result); reader.readAsDataURL(blob); });
        // colocar logo centrado en la parte superior
        const logoWidth = 140;
        doc.addImage(dataUrl, 'JPEG', (pageWidth - logoWidth) / 2, 18, logoWidth, 50);
      }
    } catch (e) {
      console.warn("No se pudo cargar logo:", e);
      // continuar sin logo
    }

    // encabezado derecho: ciclo
    doc.setFontSize(14);
    doc.setFont("helvetica","bold");
    doc.text("CICLO ESCOLAR", pageWidth - 200, 28);
    doc.setFontSize(18);
    doc.text("2025-2026", pageWidth - 200, 48);

    // datos alumno / grado
    doc.setFontSize(12);
    doc.setFont("helvetica","normal");
    doc.text(`NOMBRE DEL ALUMNO (A): ${alumno}`, margin, 100);
    doc.text(`GRADO: ${grupo}`, margin, 120);

    // preparar columnas para autoTable
    const columns = [{ header: "PerÃ­odos de evaluaciÃ³n", dataKey: "bloque" }];
    materias.forEach((m,i) => columns.push({ header: m, dataKey: `m${i}` }));

    // construir filas: 1er, 2do, 3er y Promedio final
    const rows = [];
    const rowHeaders = ["1Â°","2Â°","3Â°"];
    const trimestresOrden = ["1er Trimestre","2do Trimestre","3er Trimestre"];

    for (let r = 0; r < 3; r++) {
      const fila = { bloque: rowHeaders[r] };
      materias.forEach((m,mi) => {
        const triName = trimestresOrden[r];
        const nodeTri = datosTodasTrimestres[triName];
        let value = "-";
        if (nodeTri && nodeTri[m] && Array.isArray(nodeTri[m].datos)) {
          const idx = nodeTri[m].datos.findIndex(x => (x.alumno||"").trim() === alumno.trim());
          if (idx >= 0) value = nodeTri[m].datos[idx].calificacion ?? "-";
        }
        fila[`m${mi}`] = (value === null ? "-" : String(value));
      });
      rows.push(fila);
    }

    // Promedio por materia sÃ³lo si hay las 3 calificaciones
    const promRow = { bloque: "Promedio final" };
    let sumaPromFinal = 0;
    let contPromMedible = 0;

    materias.forEach((m,mi) => {
      const vals = [];
      trimestresOrden.forEach(triName => {
        const nodeTri = datosTodasTrimestres[triName];
        if (nodeTri && nodeTri[m] && Array.isArray(nodeTri[m].datos)) {
          const idx = nodeTri[m].datos.findIndex(x => (x.alumno||"").trim() === alumno.trim());
          if (idx >= 0) {
            const v = Number(nodeTri[m].datos[idx].calificacion);
            if (!isNaN(v)) vals.push(v);
          }
        }
      });
      if (vals.length === 3) {
        const p = (vals.reduce((a,b)=>a+b,0)/3);
        promRow[`m${mi}`] = p.toFixed(1);
        sumaPromFinal += p;
        contPromMedible++;
      } else {
        promRow[`m${mi}`] = "-";
      }
    });

    rows.push(promRow);

    // dibujar tabla con autoTable (con lÃ­neas de divisiÃ³n)
    doc.autoTable({
      startY: 150,
      head: [ columns.map(c => c.header) ],
      body: rows.map(r => columns.map((c,i) => r[c.dataKey] ?? "" )),
      styles: { fontSize:10, cellPadding:6 },
      headStyles: { fillColor: [37,97,156], textColor: 255 },
      theme: 'grid'
    });

    // asistencia / inasistencias mostradas debajo de la tabla
    const yAfter = doc.lastAutoTable.finalY + 14;
    doc.setFontSize(11);
    doc.setFont("helvetica","bold");
    doc.text("Inasistencias / Asistencias", margin, yAfter);
    doc.setFont("helvetica","normal");

    const attText = `Inasistencias: 1Â°=${asistenciasAlumnos.inasis1 || ""}   2Â°=${asistenciasAlumnos.inasis2 || ""}   3Â°=${asistenciasAlumnos.inasis3 || ""}`;
    const attText2 = `Asistencias: 1Â°=${asistenciasAlumnos.asis1 || ""}   2Â°=${asistenciasAlumnos.asis2 || ""}   3Â°=${asistenciasAlumnos.asis3 || ""}`;

    doc.text(attText, margin, yAfter + 18);
    doc.text(attText2, margin, yAfter + 34);

    // Promedio final general (si hay promedios medibles)
    let promedioFinalTexto = "-";
    if (contPromMedible > 0) promedioFinalTexto = (sumaPromFinal / contPromMedible).toFixed(1);
    doc.setFont("helvetica","bold");
    doc.text(`Promedio final de grado: ${promedioFinalTexto}`, pageWidth - 280, yAfter + 34);

    // Firmas al final (cuadros)
    const yFirma = yAfter + 70;
    doc.setDrawColor(0);
    doc.rect(margin, yFirma, 220, 60); // firma padre
    doc.text("Firma madre/padre/tutor (1er Trimestre)", margin + 6, yFirma + 16);
    doc.rect(margin + 240, yFirma, 220, 60); // 2do
    doc.text("Firma (2do Trimestre)", margin + 246, yFirma + 16);
    doc.rect(margin + 480, yFirma, 220, 60); // 3er
    doc.text("Firma (3er Trimestre)", margin + 486, yFirma + 16);

    // Nombre safe para archivo
    const safeName = alumno.replace(/[^a-z0-9]/gi,'_');
    doc.save(`Boleta_${grupo}_${safeName}.pdf`);
  }

  // imprimir todo el grupo: genera boleta por cada alumno en la tabla (iterativo)
  btnImprimirGrupo.addEventListener("click", async () => {
    const t = selTri.value;
    const g = selGrupo.value;
    if (!t || !g) return alert("Seleccione trimestre y grupo.");

    // verificar que la tabla estÃ© cargada
    const alumnoRows = Array.from(document.querySelectorAll('.alumno-row'));
    if (alumnoRows.length === 0) return alert("Cargue el grupo primero.");

    // leer datos de 3 trimestres
    const trimestres = ["1er Trimestre","2do Trimestre","3er Trimestre"];
    const datosTodas = {};
    for (const tri of trimestres) {
      const snap = await get(ref(db, `historial_casa/${tri}/${g}`));
      datosTodas[tri] = snap.exists() ? snap.val() : {};
    }

    const materias = materiasPorGrupo[g] || [];

    // generar boleta por cada alumno (esperamos cada pdf para evitar saturar)
    for (const row of alumnoRows) {
      const nombre = row.querySelector('td').textContent.trim();
      const asis = leerAsistencias(nombre);
      await generarBoletaPDF(nombre, g, t, materias, datosTodas, asis);
      await new Promise(r => setTimeout(r, 200)); // pequeÃ±o delay
    }

    alert("Se generaron las boletas (descargas iniciadas).");
  });

  // iniciar
  init();

</script>

</body>
</html>
