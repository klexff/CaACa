<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Historial de Calificaciones â€” Centro Educativo Integral Camino a Casa</title>
  <style>
    body { font-family:"Segoe UI", Arial; background:#dff3ff; margin:0; padding:20px; text-align:center; }
    header{ background:#2B82C6; color:#fff; padding:18px; box-shadow:0 3px 8px rgba(0,0,0,0.12); }
    .barra-superior{
      margin-top:10px;
      display:flex;
      justify-content:center;
      gap:10px;
    }
    .btn-top{
      border:none;
      padding:8px 12px;
      border-radius:8px;
      cursor:pointer;
      color:#fff;
      font-weight:600;
    }
    .btn-volver{ background:#6c757d; }
    .btn-salir{ background:#c0392b; }
    .contenedor-tablas { display:flex; flex-direction:column; gap:22px; margin-top:20px; align-items:center; }
    .tabla-contenedor { position:relative; width:92%; background:#fff; border-radius:10px; padding:10px; box-shadow:0 3px 10px rgba(0,0,0,0.08); }
    table{ width:100%; border-collapse:collapse; margin-top:8px; }
    th,td{ border:1px solid #ddd; padding:8px; text-align:center; }
    th{ background:#2B82C6; color:#fff; }
    .acciones { position:absolute; top:10px; right:12px; display:flex; gap:8px; }
    button{ border:none; padding:8px 10px; border-radius:8px; cursor:pointer; color:#fff; }
    .pdf{ background:#2B82C6; } .excel{ background:#28a745; } .eliminar{ background:#dc3545; }
    .mensaje{ display:none; background:#d4edda; color:#155724; padding:8px; margin:8px auto; border-radius:8px; width:80%; }
    .promedios{ margin-top:10px; font-weight:700; }
  </style>
</head>
<body>
  <header>
    <h1>ðŸ“˜ Historial de Calificaciones â€” Centro Educativo Integral Camino a Casa</h1>
  </header>

  <div class="barra-superior">
    <button id="btnVolver" class="btn-top btn-volver">â¬… Control de Trimestres</button>
    <button id="btnSalir" class="btn-top btn-salir">Salir</button>
  </div>

  <div id="mensajeConfirmacion" class="mensaje">âœ… Grupo eliminado del historial correctamente</div>
  <div class="contenedor-tablas" id="contenedorTablas"></div>

  <!-- libs -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import { getDatabase, ref, get, remove } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";
    import { jsPDF } from "https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDqty2eG_5VEi5NtU_HQzfZU_6FruMh66Q",
      authDomain: "camino-a-casa-87d65.firebaseapp.com",
      databaseURL: "https://camino-a-casa-87d65-default-rtdb.firebaseio.com",
      projectId: "camino-a-casa-87d65",
      storageBucket: "camino-a-casa-87d65.firebasestorage.app",
      messagingSenderId: "725645453280",
      appId: "1:725645453280:web:4cc41935020d1ae290ed85"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    const contenedor = document.getElementById("contenedorTablas");
    const mensajeConfirmacion = document.getElementById("mensajeConfirmacion");

    document.getElementById("btnVolver").addEventListener("click", () => {
      window.location.href = "control_trimestres.html";
    });
    document.getElementById("btnSalir").addEventListener("click", () => {
      window.location.href = "index.html";
    });

    async function cargarHistorial() {
      contenedor.innerHTML = "";
      const snap = await get(ref(db, "calificaciones"));
      if (!snap.exists()) {
        contenedor.innerHTML = "<p>No hay calificaciones registradas.</p>";
        return;
      }
      const datos = snap.val();
      for (const trimestreKey of Object.keys(datos)) {
        const gruposObj = datos[trimestreKey];
        for (const grupoKey of Object.keys(gruposObj)) {
          const materiasObj = gruposObj[grupoKey];
          const materias = Object.keys(materiasObj || {});
          if (materias.length === 0) continue;

          const alumnosSet = new Set();
          materias.forEach(m => {
            const entrada = materiasObj[m];
            (entrada.datos || []).forEach(d => alumnosSet.add(d.alumno));
          });
          const alumnos = Array.from(alumnosSet).sort((a,b)=> a.localeCompare(b,'es'));

          const contDiv = document.createElement("div");
          contDiv.className = "tabla-contenedor";
          const header = document.createElement("h3");
          header.textContent = `Grupo ${grupoKey} â€” ${trimestreKey}`;
          header.style.margin="6px 0 0 0";

          const accionesDiv = document.createElement("div");
          accionesDiv.className="acciones";

          const btnEliminar = document.createElement("button");
          btnEliminar.className="eliminar";
          btnEliminar.textContent="ðŸ—‘ï¸";
          btnEliminar.title="Eliminar tabla";
          btnEliminar.onclick = () => eliminarTabla(trimestreKey, grupoKey, contDiv);

          const btnPDF = document.createElement("button");
          btnPDF.className="pdf";
          btnPDF.textContent="ðŸ“„ PDF";
          btnPDF.onclick = () => exportarPDF_trimestre(grupoKey, trimestreKey, materiasObj);

          const btnExcel = document.createElement("button");
          btnExcel.className="excel";
          btnExcel.textContent="ðŸ“Š Excel";
          btnExcel.onclick = () => exportarExcel_trimestre(grupoKey, trimestreKey, materiasObj);

          accionesDiv.append(btnPDF, btnExcel, btnEliminar);

          const tabla = document.createElement("table");
          const thead = document.createElement("thead");
          const headRow = document.createElement("tr");
          headRow.innerHTML = "<th>Alumno</th>" + materias.map(m=>`<th>${m}</th>`).join("");
          thead.appendChild(headRow);

          const tbody = document.createElement("tbody");
          alumnos.forEach(alumno => {
            const tr = document.createElement("tr");
            let inner = `<td>${alumno}</td>`;
            materias.forEach(m=> {
              const entrada = materiasObj[m];
              const encontrado = (entrada.datos || []).find(d => d.alumno === alumno);
              inner += `<td>${encontrado ? encontrado.calificacion : "-"}</td>`;
            });
            tr.innerHTML = inner;
            tbody.appendChild(tr);
          });

          tabla.appendChild(thead);
          tabla.appendChild(tbody);

          const promediosDiv = document.createElement("div");
          promediosDiv.className="promedios";
          let texto = "<b>Promedio por Materia:</b> ";
          let sumaTotal=0; let contTotal=0;
          materias.forEach((m)=> {
            const entrada = materiasObj[m];
            let s=0, c=0;
            (entrada.datos || []).forEach(d => {
              if (!isNaN(d.calificacion)) { s += Number(d.calificacion); c++; }
            });
            const pm = c>0 ? (s/c).toFixed(1) : "-";
            texto += `${m}: ${pm}  `;
            if (c>0) { sumaTotal += s; contTotal += c; }
          });
          const promGrupal = contTotal>0 ? (sumaTotal/contTotal).toFixed(1) : "-";
          texto += ` | <b>Promedio Grupal:</b> ${promGrupal}`;
          promediosDiv.innerHTML = texto;

          contDiv.append(header, accionesDiv, tabla, promediosDiv);
          contenedor.appendChild(contDiv);
        }
      }
    }

    async function eliminarTabla(trimestreKey, grupoKey, contDiv) {
      if (!confirm("Â¿Seguro que deseas eliminar esta tabla completa?")) return;
      try {
        await remove(ref(db, `calificaciones/${encodeKey(trimestreKey)}/${encodeKey(grupoKey)}`));
        contDiv.remove();
        mensajeConfirmacion.style.display="block";
        setTimeout(()=> mensajeConfirmacion.style.display="none", 2000);
      } catch(e){ console.error(e); alert("Error al eliminar"); }
    }

    function encodeKey(s){ return s.replace(/\./g,"_"); }

    function exportarExcel_trimestre(grupo, trimestre, materiasObj) {
      const container = document.createElement("div");
      const table = document.createElement("table");

      const caption = document.createElement("caption");
      caption.textContent = "Centro Educativo Integral Camino a Casa";
      caption.style.fontWeight = "bold";
      table.appendChild(caption);

      const thead = document.createElement("thead");
      const materias = Object.keys(materiasObj);
      const headRow = document.createElement("tr");
      headRow.innerHTML = "<th>Alumno</th>" + materias.map(m=>`<th>${m}</th>`).join("");
      thead.appendChild(headRow);
      table.appendChild(thead);

      const tbody = document.createElement("tbody");
      const alumnosSet = new Set();
      materias.forEach(m => (materiasObj[m].datos || []).forEach(d=> alumnosSet.add(d.alumno)));
      const alumnos = Array.from(alumnosSet).sort((a,b)=> a.localeCompare(b,'es'));
      alumnos.forEach(alumno => {
        const tr = document.createElement("tr");
        let inner = `<td>${alumno}</td>`;
        materias.forEach(m=>{
          const entrada = materiasObj[m];
          const encontrado = (entrada.datos||[]).find(d=>d.alumno===alumno);
          inner += `<td>${encontrado? encontrado.calificacion : ""}</td>`;
        });
        tr.innerHTML = inner; tbody.appendChild(tr);
      });
      table.appendChild(tbody);
      container.appendChild(table);
      const wb = XLSX.utils.table_to_book(table, {sheet: "Calificaciones"});
      XLSX.writeFile(wb, `Calificaciones_${grupo}_${trimestre}.xlsx`);
    }

    async function exportarPDF_trimestre(grupo, trimestre, materiasObj) {
      const { jsPDF } = await import("https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js");
      const doc = new jsPDF({ orientation: "landscape" });

      // Logo
      try {
        const img = new Image();
        img.src = "logo_camino_a_casa.png";
        await new Promise((res, rej) => {
          img.onload = res;
          img.onerror = rej;
        });
        const logoWidth = 35;
        const ratio = img.height / img.width;
        const logoHeight = logoWidth * ratio;
        doc.addImage(img, "PNG", 12, 5, logoWidth, logoHeight);
      } catch (e) {
        console.warn("No se pudo cargar el logo para el PDF:", e);
      }

      doc.setFontSize(16);
      doc.setTextColor(43,130,198);
      doc.text(`Centro Educativo Integral Camino a Casa`, 148, 12, {align:"center"});
      doc.setFontSize(14);
      doc.text(`Calificaciones - Grupo ${grupo} - ${trimestre}`, 148, 22, {align:"center"});

      const materias = Object.keys(materiasObj);
      const headers = ["Alumno", ...materias];
      const rows = [];
      const alumnosSet = new Set();
      materias.forEach(m => (materiasObj[m].datos || []).forEach(d=> alumnosSet.add(d.alumno)));
      const alumnos = Array.from(alumnosSet).sort((a,b)=> a.localeCompare(b,'es'));
      alumnos.forEach(alumno=>{
        const row = [alumno];
        materias.forEach(m=>{
          const entrada = materiasObj[m];
          const encontrado = (entrada.datos||[]).find(d=>d.alumno===alumno);
          row.push(encontrado? String(encontrado.calificacion) : "-");
        });
        rows.push(row);
      });

      doc.autoTable({
        startY: 30,
        head: [headers],
        body: rows,
        theme: "striped",
        headStyles: { fillColor: [43,130,198], textColor: 255 },
        styles: { halign: "center", fontSize: 9 }
      });

      let suma=0, cuenta=0;
      materias.forEach(m=>{
        (materiasObj[m].datos||[]).forEach(d=> {
          if (!isNaN(d.calificacion)) { suma += Number(d.calificacion); cuenta++; }
        });
      });
      const prom = cuenta>0 ? (suma/cuenta).toFixed(1) : "N/A";
      const finalY = doc.lastAutoTable ? doc.lastAutoTable.finalY + 10 : 200;
      doc.setFontSize(12);
      doc.setTextColor(43,130,198);
      doc.setFont(undefined,"bold");
      doc.text(`Promedio Grupal: ${prom}`, 280, finalY, { align: "right" });
      doc.line(220, finalY+1, 280, finalY+1);

      doc.save(`Calificaciones_${grupo}_${trimestre}.pdf`);
    }

    (function init(){ cargarHistorial(); })();
  </script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
</body>
</html>
