<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Calificaciones ‚Äî Centro Educativo Integral Camino a Casa</title>

  <style>
    body {
      font-family:"Segoe UI", Arial;
      background:#eef5f1;
      margin:0;
      padding:20px;
      text-align:center;
    }

    header {
      background:linear-gradient(90deg,#25619c,#2f8c4a);
      color:#fff;
      padding:18px;
      box-shadow:0 3px 8px rgba(0,0,0,0.12);
    }

    main { max-width:1100px; margin:16px auto; text-align:left; }

    table {
      width:100%;
      border-collapse:collapse;
      background:#fff;
      border-radius:10px;
      overflow:hidden;
      box-shadow:0 2px 6px rgba(0,0,0,0.08);
    }

    th,td {
      border:1px solid #ddd;
      padding:8px;
      text-align:center;
    }

    th {
      background:#25619c;
      color:#fff;
    }

    input, select {
      padding:6px;
      border-radius:6px;
      border:1px solid #ccc;
    }

    .guardar {
      background:#25619c;
      color:#fff;
      padding:8px 12px;
      border-radius:8px;
      border:none;
      cursor:pointer;
      font-weight:600;
      min-width:120px;
    }

    .salir {
      background:#c0392b;
      color:#fff;
      padding:8px 12px;
      border-radius:8px;
      border:none;
      cursor:pointer;
      font-weight:600;
      min-width:120px;
    }

    .agregar {
      background:#2f8c4a;
      color:#fff;
      padding:8px 12px;
      border-radius:8px;
      border:none;
      cursor:pointer;
      font-weight:600;
      min-width:120px;
    }

    .editar {
      background:#ffc107;
      color:#000;
      border:none;
      padding:6px 8px;
      border-radius:6px;
      cursor:pointer;
    }

    .eliminar {
      background:#c0392b;
      color:#fff;
      border:none;
      padding:6px 8px;
      border-radius:6px;
      cursor:pointer;
    }

    .rojo{background:#f8d7da;}
    .amarillo{background:#fff3cd;}
    .verde{background:#d4edda;}

    .mensajeExito {
      background:#d4edda;
      border:1px solid #c3e6cb;
      color:#155724;
      padding:10px;
      border-radius:8px;
      margin-top:12px;
      display:none;
      text-align:center;
      font-weight:600;
    }

    label { font-weight:700; margin-right:8px; }

    .botonera {
      display:flex;
      gap:10px;
      justify-content:center;
      flex-wrap:wrap;
      margin-top:10px;
    }
  </style>
</head>

<body>

<header><h1>üìù Registro de Calificaciones</h1></header>

<main>

  <div id="alertaTrimestre" style="padding:10px; background:#fff3cd; border-radius:8px; margin-bottom:12px;">
    Cargando informaci√≥n de trimestres...
  </div>

  <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin-bottom:10px;">

    <label>Trimestre:</label>
    <select id="trimestre"></select>

    <label>Grupo:</label>
    <select id="grupo">
      <option value="">Seleccione...</option>
      <option value="1¬∞">1¬∞</option>
      <option value="2¬∞">2¬∞</option>
      <option value="3¬∞">3¬∞</option>
    </select>

    <label>Materia:</label>
    <select id="materia"><option value="">Seleccione...</option></select>

    <label>Docente:</label>
    <input id="docente" placeholder="Nombre del docente" />

  </div>

  <div class="botonera">
    <button id="btnGuardar" class="guardar">Guardar</button>
    <button id="btnNuevoMateria" class="agregar">Nueva Materia</button>
    <button id="btnSalir" class="salir">Salir</button>
  </div>

  <table id="tablaCalificaciones">
    <thead>
      <tr><th>Alumno</th><th>Calificaci√≥n</th><th>Acciones</th></tr>
    </thead>
    <tbody></tbody>
    <tfoot>
      <tr><th>Promedio del grupo</th><th id="promedioGrupo">-</th><th></th></tr>
    </tfoot>
  </table>

  <div id="mensajeExito" class="mensajeExito"></div>

</main>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
  import { getDatabase, ref, set, get } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDqty2eG_5VEi5NtU_HQzfZU_6FruMh66Q",
    authDomain: "camino-a-casa-87d65.firebaseapp.com",
    databaseURL: "https://camino-a-casa-87d65-default-rtdb.firebaseio.com",
    projectId: "camino-a-casa-87d65",
    storageBucket: "camino-a-casa-87d65.firebasestorage.app",
    messagingSenderId: "725645453280",
    appId: "1:725645453280:web:4cc41935020d1ae290ed85"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  const materiasPorGrupo = {
    "1¬∞": ["Matem√°ticas 1","Espa√±ol 1","Biolog√≠a 1","Geograf√≠a 1","Danza 1","Educaci√≥n F√≠sica 1","Historia I","√âtica I","Ingl√©s 1","Gastronom√≠a 1","Habilidades Digitales 1"],
    "2¬∞": ["Matem√°ticas 2","Espa√±ol 2","Danza 2","√âtica II","F√≠sica 2","Ingl√©s 2","Educaci√≥n F√≠sica 2","Historia II","Gastronom√≠a 2","Habilidades Digitales 2"],
    "3¬∞": ["Matem√°ticas 3","Espa√±ol 3","Ingl√©s 3","Danza 3","√âtica III","Vida Saludable 3","Historia III","Educaci√≥n F√≠sica 3","Gastronom√≠a 3","Habilidades Digitales 3","Qu√≠mica 3"]
  };

const alumnosPorGrupo = {
  "1¬∞": [
    "Cesar D. Hernandez",
    "A. Santiago Sanchez",
    "Isabella Barragan",
    "V. Victoria Rios",
    "Samuel Tassias"
  ],

  "2¬∞": [
    "Mateo A. Vazquez",
    "Mario N. Gordillo",
    "Julieta Salinas",
    "Alisson Valencia"
  ],

  "3¬∞": [
    "Hector Penagos",
    "David A. Gil",
    "Damian Alcazar",
    "Ruben Solis",
    "Paulina Ruiz",
    "Grecia Morales",
    "Hiram Rodas",
    "Jesus Borbollan"
  ]
};


  const cuerpoTabla = document.querySelector("#tablaCalificaciones tbody");
  const promedioGrupo = document.getElementById("promedioGrupo");
  const mensajeExito = document.getElementById("mensajeExito");

  document.addEventListener("DOMContentLoaded", async () => {
    await cargarTrimestre();

    document.getElementById("grupo").addEventListener("change", actualizarGrupo);
    document.getElementById("btnGuardar").addEventListener("click", guardar);
    document.getElementById("btnNuevoMateria").addEventListener("click", nuevaMateria);

    document.getElementById("btnSalir").addEventListener("click", () => {
      window.location.href = "index.html";
    });
  });

  async function cargarTrimestre() {
    const snap = await get(ref(db, "configuracion/trimestreActivo"));
    const select = document.getElementById("trimestre");
    const alertaTrimestre = document.getElementById("alertaTrimestre");

    if (!snap.exists()) {
      alertaTrimestre.textContent = "üö´ No hay trimestre activo.";
      return;
    }

    const t = snap.val();
    alertaTrimestre.innerHTML = `‚úî Trimestre activo: <b>${t.nombre}</b> (${t.inicio} al ${t.fin})`;

    const opt = document.createElement("option");
    opt.value = t.nombre;
    opt.textContent = t.nombre;
    select.appendChild(opt);
  }

  function actualizarGrupo() {
    const grupo = document.getElementById("grupo").value;
    cargarMaterias(grupo);
    cargarAlumnos(grupo);
  }

  function cargarMaterias(grupo) {
    const m = document.getElementById("materia");
    m.innerHTML = "<option value=''>Seleccione...</option>";

    if (!grupo) return;

    materiasPorGrupo[grupo]?.forEach(mat => {
      const op = document.createElement("option");
      op.value = mat;
      op.textContent = mat;
      m.appendChild(op);
    });
  }

  async function cargarAlumnos(grupo) {
    cuerpoTabla.innerHTML = "";
    promedioGrupo.textContent = "-";

    if (!grupo) return;

    try {
      const snap = await get(ref(db, "alumnos"));
      const lista = [];

      if (snap.exists()) {
        const all = snap.val();

        for (const id in all) {
          const item = all[id];
          if (item?.grupo === grupo) {
            lista.push({ id, nombre: item.nombre });
          }
        }
      }

      if (lista.length > 0) {
        lista.sort((a,b)=>a.nombre.localeCompare(b.nombre));

        lista.forEach(a => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td contenteditable="true">${a.nombre}</td>
            <td contenteditable="true" onblur="validarCalificacion(this)"></td>
            <td>
              <button class="editar" onclick="editarFila(this)">‚úèÔ∏è</button>
              <button class="eliminar" onclick="eliminarFila(this)">üóëÔ∏è</button>
            </td>
          `;
          cuerpoTabla.appendChild(tr);
        });
        return;
      }

      alumnosPorGrupo[grupo].forEach(nombre => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td contenteditable="true">${nombre}</td>
          <td contenteditable="true" onblur="validarCalificacion(this)"></td>
          <td>
            <button class="editar" onclick="editarFila(this)">‚úèÔ∏è</button>
            <button class="eliminar" onclick="eliminarFila(this)">üóëÔ∏è</button>
          </td>
        `;
        cuerpoTabla.appendChild(tr);
      });

    } catch (err) {
      console.error("Error leyendo alumnos:", err);
    }
  }

  function nuevaMateria() {
    if (!confirm("¬øDeseas iniciar captura para una nueva materia?")) return;
    cuerpoTabla.innerHTML = "";
    promedioGrupo.textContent = "-";
    document.getElementById("materia").selectedIndex = 0;
    mensajeExito.style.display = "none";
  }

  window.validarCalificacion = function(td){
    let v = td.textContent.trim();
    if (!/^\d+$/.test(v)) { td.textContent=""; return; }
    v = parseInt(v,10);

    // ‚úî AHORA ACEPTA CALIFICACIONES DESDE 5
    if (v < 5 || v > 10) { td.textContent=""; return; }

    aplicarColor(td,v);
    calcularPromedio();
  };

  function aplicarColor(td,v){
    td.className="";
    if (v<7) td.classList.add("rojo");
    else if (v<=8) td.classList.add("amarillo");
    else td.classList.add("verde");
  }

  window.editarFila = b => b.closest("tr").querySelector("td").focus();
  window.eliminarFila = b => { b.closest("tr").remove(); calcularPromedio(); };

  function calcularPromedio(){
    const notas=[...document.querySelectorAll("#tablaCalificaciones tbody td:nth-child(2)")]
      .map(td=>parseInt(td.textContent))
      .filter(n=>!isNaN(n));

    if (notas.length===0) return promedioGrupo.textContent="-";

    const pr=(notas.reduce((a,b)=>a+b,0)/notas.length).toFixed(1);
    promedioGrupo.textContent=pr;
  }

  async function guardar(){
    const trimestre=document.getElementById("trimestre").value;
    const grupo=document.getElementById("grupo").value;
    const materia=document.getElementById("materia").value;
    const docente=document.getElementById("docente").value.trim();

    if(!trimestre||!grupo||!materia||!docente){
      alert("Complete todos los campos.");
      return;
    }

    const filas=[...document.querySelectorAll("#tablaCalificaciones tbody tr")];
    const datos=filas.map(f=>({
      alumno:f.cells[0].textContent.trim(),
      calificacion:parseInt(f.cells[1].textContent.trim())||null
    }));

    for(const d of datos){
      if(!d.alumno || d.calificacion===null){
        alert("Complete todos los datos.");
        return;
      }
    }

    const path=`calificaciones/${encode(trimestre)}/${encode(grupo)}/${encode(materia)}`;

    await set(ref(db,path),{
      docente,
      datos,
      savedAt: new Date().toISOString()
    });

    mensajeExito.style.display="block";
    mensajeExito.textContent=`‚úî Calificaciones guardadas correctamente`;
    setTimeout(()=> mensajeExito.style.display="none", 3500);
  }

  function encode(s){ return s.replace(/\./g,"_"); }

</script>

</body>
</html>
