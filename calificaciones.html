<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Calificaciones ‚Äî Centro Educativo Integral Camino a Casa</title>
  <style>
    body { font-family: "Segoe UI", Arial, sans-serif; background:#f5f8ff; margin:0; padding:20px; text-align:center; }
    header { background:linear-gradient(90deg,#007bff,#00a2ff); color:#fff; padding:18px; box-shadow:0 3px 8px rgba(0,0,0,0.12); }
    main { max-width:1100px; margin:16px auto; text-align:left; }
    table { width:100%; border-collapse:collapse; background:#fff; border-radius:10px; overflow:hidden; box-shadow:0 2px 6px rgba(0,0,0,0.08); }
    th,td { border:1px solid #ddd; padding:8px; text-align:center; }
    th { background:#007bff; color:#fff; }
    input, select { padding:6px; border-radius:6px; border:1px solid #ccc; }
    .agregar { background:#28a745; color:#fff; padding:8px 12px; border-radius:8px; border:none; }
    .guardar { background:#007bff; color:#fff; padding:8px 12px; border-radius:8px; border:none; }
    .editar { background:#ffc107; color:#000; border:none; padding:6px 8px; border-radius:6px; }
    .eliminar { background:#dc3545; color:#fff; border:none; padding:6px 8px; border-radius:6px; }
    .rojo{background:#f8d7da;} .amarillo{background:#fff3cd;} .verde{background:#d4edda;}
    .mensajeExito { background:#d4edda; border:1px solid #c3e6cb; color:#155724; padding:10px; border-radius:8px; margin-top:12px; display:none; text-align:center; }
    label { font-weight:700; margin-right:8px; }
    .center { text-align:center; }
  </style>
</head>
<body>
  <header><h1>üìù Registro de Calificaciones ‚Äî Centro Educativo Integral Camino a Casa</h1></header>

  <main>
    <div id="alertaTrimestre" style="padding:10px; background:#fff3cd; border-radius:8px; margin-bottom:12px;">Cargando informaci√≥n de trimestres...</div>

    <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin-bottom:10px;">
      <label>Trimestre:</label>
      <select id="trimestre"></select>

      <label>Grupo:</label>
      <select id="grupo">
        <option value="">Seleccione...</option>
        <option value="1¬∞">1¬∞</option>
        <option value="2¬∞">2¬∞</option>
        <option value="3¬∞">3¬∞</option>
      </select>

      <label>Materia:</label>
      <select id="materia"><option>Seleccione...</option></select>

      <label>Docente:</label>
      <input id="docente" placeholder="Nombre del docente" />

      <button id="btnAgregar" class="agregar">Aceptar / Agregar Alumno</button>
      <button id="btnNuevoMateria" class="agregar">Agregar Nueva Materia</button>
      <button id="btnGuardar" class="guardar">Guardar Calificaciones</button>
    </div>

    <table id="tablaCalificaciones">
      <thead><tr><th>Alumno</th><th>Calificaci√≥n</th><th>Acciones</th></tr></thead>
      <tbody></tbody>
      <tfoot><tr><th>Promedio del grupo</th><th id="promedioGrupo">-</th><th></th></tr></tfoot>
    </table>

    <div id="mensajeExito" class="mensajeExito"></div>
  </main>

  <!-- Firebase SDK (v10.8.0) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import { getDatabase, ref, set, get, push, onValue } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDqty2eG_5VEi5NtU_HQzfZU_6FruMh66Q",
      authDomain: "camino-a-casa-87d65.firebaseapp.com",
      databaseURL: "https://camino-a-casa-87d65-default-rtdb.firebaseio.com",
      projectId: "camino-a-casa-87d65",
      storageBucket: "camino-a-casa-87d65.firebasestorage.app",
      messagingSenderId: "725645453280",
      appId: "1:725645453280:web:4cc41935020d1ae290ed85"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // materias por grupo (como definiste)
    const materiasPorGrupo = {
      "1¬∞": ["Matem√°ticas 1","Espa√±ol 1","Biolog√≠a 1","Geograf√≠a 1","Danza 1","Educaci√≥n F√≠sica 1","Historia I","√âtica I","Ingl√©s 1","Gastronom√≠a 1","Habilidades Digitales 1"],
      "2¬∞": ["Matem√°ticas 2","Espa√±ol 2","Danza 2","√âtica II","F√≠sica 2","Ingl√©s 2","Educaci√≥n F√≠sica 2","Historia II","Gastronom√≠a 2","Habilidades Digitales 2"],
      "3¬∞": ["Matem√°ticas 3","Espa√±ol 3","Ingl√©s 3","Danza 3","√âtica III","Vida Saludable 3","Historia III","Educaci√≥n F√≠sica 3","Gastronom√≠a 3","Habilidades Digitales 3","Qu√≠mica 3"]
    };

    const cuerpoTabla = document.querySelector("#tablaCalificaciones tbody");
    const promedioGrupo = document.getElementById("promedioGrupo");
    const alertaTrimestre = document.getElementById("alertaTrimestre");
    const mensajeExito = document.getElementById("mensajeExito");

    document.addEventListener("DOMContentLoaded", async () => {
      await cargarTrimestres();
      document.getElementById("btnAgregar").addEventListener("click", agregarFila);
      document.getElementById("btnGuardar").addEventListener("click", guardarCalificaciones);
      document.getElementById("btnNuevoMateria").addEventListener("click", nuevaMateria);
      document.getElementById("grupo").addEventListener("change", actualizarMaterias);
      // Disabled Enter in contenteditable cells:
      document.addEventListener("keydown", (e) => {
        if (e.key === "Enter" && (document.activeElement && (document.activeElement.isContentEditable || document.activeElement.tagName === "INPUT"))) {
          e.preventDefault();
        }
      });
    });

    async function cargarTrimestres() {
      const snap = await get(ref(db, "configuracion/trimestreActivo"));
      const select = document.getElementById("trimestre");
      select.innerHTML = "";
      if (!snap.exists()) {
        alertaTrimestre.textContent = "üö´ No hay trimestres activos. El registro de calificaciones est√° deshabilitado temporalmente.";
        alertaTrimestre.style.background = "#f8d7da";
        select.disabled = true;
        return;
      }
      const activo = snap.val();
      alertaTrimestre.innerHTML = `‚úÖ Trimestre activo: <b>${activo.nombre}</b> (Del ${activo.inicio} al ${activo.fin})`;
      select.disabled = false;
      const opt = document.createElement("option"); opt.value = activo.nombre; opt.textContent = activo.nombre; select.appendChild(opt);
    }

    function actualizarMaterias() {
      const grupo = document.getElementById("grupo").value;
      const materiaSelect = document.getElementById("materia");
      materiaSelect.innerHTML = "";
      if (!grupo) { materiaSelect.innerHTML = "<option>Seleccione un grupo primero...</option>"; return; }
      materiasPorGrupo[grupo].forEach(m => { const opt = document.createElement("option"); opt.value = m; opt.textContent = m; materiaSelect.appendChild(opt); });
    }

    function agregarFila() {
      const fila = document.createElement("tr");
      fila.innerHTML = `<td contenteditable="true"></td>
                        <td contenteditable="true" onblur="validarCalificacion(this)"></td>
                        <td>
                          <button class="editar" onclick="editarFila(this)">‚úèÔ∏è</button>
                          <button class="eliminar" onclick="eliminarFila(this)">üóëÔ∏è</button>
                        </td>`;
      cuerpoTabla.appendChild(fila);
      fila.querySelector("td").focus();
    }

    function validarCalificacion(td) {
      let nota = td.textContent.trim();
      if (nota === "") return;
      if (!/^\d{1,2}$/.test(nota)) { alert("‚ö†Ô∏è Ingrese un n√∫mero entero entre 6 y 10."); td.textContent=""; return; }
      let num = parseInt(nota,10);
      if (num<6||num>10) { alert("‚ö†Ô∏è La calificaci√≥n debe estar entre 6 y 10."); td.textContent=""; return; }
      td.textContent = num;
      aplicarColor(td,num);
      calcularPromedio();
    }

    function aplicarColor(td, nota) {
      td.className = "";
      if (nota<7) td.classList.add("rojo");
      else if (nota<=8) td.classList.add("amarillo");
      else td.classList.add("verde");
    }

    function editarFila(btn) {
      const fila = btn.closest("tr");
      fila.querySelector("td").focus();
    }

    function eliminarFila(btn) {
      btn.closest("tr").remove();
      calcularPromedio();
    }

    function calcularPromedio() {
      const celdas = [...document.querySelectorAll("#tablaCalificaciones tbody td:nth-child(2)")];
      let notas = celdas.map(td => parseInt(td.textContent)).filter(n => !isNaN(n));
      if (notas.length===0) { promedioGrupo.textContent="-"; return; }
      const prom = (notas.reduce((a,b)=>a+b,0)/notas.length).toFixed(1);
      promedioGrupo.textContent = prom;
    }

    async function guardarCalificaciones() {
      const trimestre = document.getElementById("trimestre").value;
      const materia = document.getElementById("materia").value;
      const grupo = document.getElementById("grupo").value;
      const docente = document.getElementById("docente").value.trim();

      if (!trimestre||!materia||!grupo||!docente) { alert("‚ö†Ô∏è Complete todos los campos antes de guardar."); return; }

      const filas = [...document.querySelectorAll("#tablaCalificaciones tbody tr")];
      if (filas.length===0) { alert("‚ö†Ô∏è No hay alumnos registrados."); return; }

      const datos = filas.map(f => ({ alumno: f.cells[0].textContent.trim(), calificacion: parseInt(f.cells[1].textContent.trim()) || null }));

      // Validaciones: no decimales, no menores a 6
      for (const d of datos) {
        if (!d.alumno) { alert("‚ö†Ô∏è Rellene el nombre de todos los alumnos."); return; }
        if (d.calificacion === null) { alert("‚ö†Ô∏è Rellene todas las calificaciones."); return; }
        if (d.calificacion < 6 || d.calificacion > 10 || !Number.isInteger(d.calificacion)) { alert("‚ö†Ô∏è Calificaciones enteras entre 6 y 10."); return; }
      }

      // Guardar en Firebase: estructura /calificaciones/{trimestre}/{grupo}/{materia}
      const path = `calificaciones/${encodeKey(trimestre)}/${encodeKey(grupo)}/${encodeKey(materia)}`;
      try {
        await set(ref(db, path), { docente, datos, savedAt: new Date().toISOString() });
        mensajeExito.style.display = "block";
        mensajeExito.textContent = `‚úÖ Calificaciones guardadas correctamente para ${materia} - ${grupo} (${trimestre}).`;
        setTimeout(()=> mensajeExito.style.display="none", 4000);
      } catch (err) {
        console.error(err); alert("‚ùå Error al guardar en la nube. Revise su conexi√≥n.");
      }
    }

    function nuevaMateria() {
      if (!confirm("¬øDeseas agregar una nueva materia? Se limpiar√° la tabla actual.")) return;
      cuerpoTabla.innerHTML = "";
      promedioGrupo.textContent = "";
      document.getElementById("materia").selectedIndex = 0;
      document.getElementById("docente").value = "";
      mensajeExito.style.display = "none";
    }

    function encodeKey(s) { return s.replace(/\./g,"_"); } // para keys seguras
  </script>
</body>
</html>
