<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Registro de Calificaciones</title>
  <style>
    body {
      font-family: "Segoe UI", Arial, sans-serif;
      background-color: #f5f8ff;
      margin: 0;
      padding: 0;
      text-align: center;
    }

    header {
      background: linear-gradient(90deg, #007bff, #00a2ff);
      color: white;
      text-align: center;
      padding: 20px;
      box-shadow: 0 3px 8px rgba(0, 0, 0, 0.2);
    }

    main {
      padding: 20px;
      max-width: 1100px;
      margin: auto;
      text-align: center;
    }

    table {
      width: 80%;
      margin: 20px auto;
      border-collapse: collapse;
      background-color: white;
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
    }

    th, td {
      border: 1px solid #ddd;
      text-align: center;
      padding: 8px;
    }

    th {
      background-color: #007bff;
      color: white;
    }

    input, select {
      padding: 6px;
      border-radius: 5px;
      border: 1px solid #ccc;
      margin: 3px;
    }

    button {
      padding: 6px 10px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      color: white;
      font-weight: bold;
      margin: 3px;
      font-size: 0.9em;
    }

    .aceptar { background-color: #17a2b8; } /* color discreto */
    .agregar { background-color: #28a745; }
    .guardar { background-color: #007bff; }
    .editar { background-color: #ffc107; color: black; }
    .eliminar { background-color: #dc3545; }

    .rojo { background-color: #f8d7da; }
    .amarillo { background-color: #fff3cd; }
    .verde { background-color: #d4edda; }

    .alerta {
      padding: 10px;
      border-radius: 10px;
      text-align: center;
      margin-bottom: 15px;
      width: 80%;
      margin-left: auto;
      margin-right: auto;
    }

    .advertencia {
      background-color: #fff3cd;
      border: 1px solid #ffeeba;
      color: #856404;
    }

    .bloqueado {
      background-color: #f8d7da;
      border: 1px solid #f5c6cb;
      color: #721c24;
    }

    .mensajeExito {
      background-color: #d4edda;
      border: 1px solid #c3e6cb;
      color: #155724;
      padding: 10px;
      margin-top: 10px;
      border-radius: 8px;
      text-align: center;
      font-weight: bold;
      width: 80%;
      margin-left: auto;
      margin-right: auto;
      position: fixed;
      top: 0;
      left: 50%;
      transform: translateX(-50%);
      z-index: 999;
      display: none;
      animation: fadeInOut 3s ease-in-out forwards;
    }

    @keyframes fadeInOut {
      0% { opacity: 0; top: -50px; }
      10% { opacity: 1; top: 20px; }
      90% { opacity: 1; top: 20px; }
      100% { opacity: 0; top: -50px; }
    }

    label { font-weight: bold; }
  </style>
</head>
<body>

  <header>
    <h1>üìù Registro de Calificaciones</h1>
  </header>

  <div id="mensajeExito" class="mensajeExito"></div>

  <main>
    <div id="alertaTrimestre" class="alerta advertencia">Cargando informaci√≥n de trimestres...</div>

    <div>
      <label>Trimestre:</label>
      <select id="trimestre"></select>

      <label>Grupo:</label>
      <select id="grupo" onchange="actualizarMaterias()">
        <option value="">Seleccione...</option>
        <option value="1¬∞">1¬∞</option>
        <option value="2¬∞">2¬∞</option>
        <option value="3¬∞">3¬∞</option>
      </select>

      <label>Materia:</label>
      <select id="materia">
        <option value="">Seleccione un grupo primero...</option>
      </select>

      <label>Docente:</label>
      <input type="text" id="docente" placeholder="Nombre del docente">

      <div>
        <button class="agregar" id="btnNuevoAlumno">Agregar Alumno</button>
        <button class="guardar" onclick="guardarCalificaciones()">Guardar Calificaciones</button>
        <button class="agregar" onclick="nuevaMateria()">Agregar Nueva Materia</button>
      </div>
    </div>

    <table id="tablaCalificaciones">
      <thead>
        <tr>
          <th>Alumno</th>
          <th>Calificaci√≥n</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody></tbody>
      <tfoot>
        <tr>
          <th>Promedio del grupo</th>
          <th id="promedioGrupo"></th>
          <th></th>
        </tr>
      </tfoot>
    </table>
  </main>

  <script>
    const cuerpoTabla = document.querySelector("#tablaCalificaciones tbody");
    const promedioGrupo = document.getElementById("promedioGrupo");
    const alertaTrimestre = document.getElementById("alertaTrimestre");
    const mensajeExito = document.getElementById("mensajeExito");

    const materiasPorGrupo = {
      "1¬∞": ["Matem√°ticas 1", "Espa√±ol 1", "Biolog√≠a 1", "Geograf√≠a 1", "Danza 1", "Educaci√≥n F√≠sica 1", "Historia I", "√âtica I", "Ingl√©s 1", "Gastronom√≠a 1", "Habilidades Digitales 1"],
      "2¬∞": ["Matem√°ticas 2", "Espa√±ol 2", "Danza 2", "√âtica II", "F√≠sica 2", "Ingl√©s 2", "Educaci√≥n F√≠sica 2", "Historia II", "Gastronom√≠a 2", "Habilidades Digitales 2"],
      "3¬∞": ["Matem√°ticas 3", "Espa√±ol 3", "Ingl√©s 3", "Danza 3", "√âtica III", "Vida Saludable 3", "Historia III", "Educaci√≥n F√≠sica 3", "Gastronom√≠a 3", "Habilidades Digitales 3", "Qu√≠mica 3"]
    };

    document.addEventListener("DOMContentLoaded", () => {
      cargarTrimestres();
      document.getElementById("btnNuevoAlumno").addEventListener("click", agregarFila);
    });

    function cargarTrimestres() {
      const trimestres = JSON.parse(localStorage.getItem("trimestres")) || [];
      const activos = trimestres.filter(t => t.activo);
      const select = document.getElementById("trimestre");
      select.innerHTML = "";

      if (activos.length === 0) {
        alertaTrimestre.textContent = "üö´ No hay trimestres activos.";
        alertaTrimestre.className = "alerta bloqueado";
        select.disabled = true;
        return;
      }

      alertaTrimestre.innerHTML = `‚úÖ Trimestre activo: <b>${activos[0].nombre}</b> (Del ${activos[0].inicio} al ${activos[0].fin})`;
      alertaTrimestre.className = "alerta advertencia";

      activos.forEach(t => {
        const opt = document.createElement("option");
        opt.value = t.nombre;
        opt.textContent = t.nombre;
        select.appendChild(opt);
      });
    }

    function actualizarMaterias() {
      const grupo = document.getElementById("grupo").value;
      const materiaSelect = document.getElementById("materia");
      materiaSelect.innerHTML = "";
      if (!grupo) {
        materiaSelect.innerHTML = "<option value=''>Seleccione un grupo primero...</option>";
        return;
      }
      materiasPorGrupo[grupo].forEach(m => {
        const opt = document.createElement("option");
        opt.value = m;
        opt.textContent = m;
        materiaSelect.appendChild(opt);
      });
    }

    function agregarFila() {
      const fila = document.createElement("tr");
      fila.innerHTML = `
        <td contenteditable="true" onkeydown="bloquearEnter(event)"></td>
        <td contenteditable="true" onblur="validarCalificacion(this)" onkeydown="bloquearEnter(event)"></td>
        <td>
          <button class="aceptar" onclick="aceptarFila(this)">‚úîÔ∏è</button>
          <button class="editar" onclick="editarFila(this)">‚úèÔ∏è</button>
          <button class="eliminar" onclick="eliminarFila(this)">üóëÔ∏è</button>
        </td>
      `;
      cuerpoTabla.appendChild(fila);
    }

    function bloquearEnter(event) {
      if (event.key === "Enter") {
        event.preventDefault();
      }
    }

    function validarCalificacion(td) {
      let nota = td.textContent.trim();
      if (nota === "") return;
      if (!/^\d{1,2}$/.test(nota)) {
        td.textContent = "";
        return;
      }
      let num = parseInt(nota, 10);
      if (num < 6 || num > 10) {
        td.textContent = "";
        return;
      }
      td.textContent = num;
      aplicarColor(td, num);
      calcularPromedio();
    }

    function aplicarColor(td, nota) {
      td.className = "";
      if (nota < 7) td.classList.add("rojo");
      else if (nota <= 8) td.classList.add("amarillo");
      else td.classList.add("verde");
    }

    function aceptarFila(btn) {
      const fila = btn.closest("tr");
      const alumno = fila.cells[0].textContent.trim();
      const calificacion = fila.cells[1].textContent.trim();
      if (!alumno || !calificacion) {
        alert("‚ö†Ô∏è Complete el nombre del alumno y la calificaci√≥n antes de aceptar.");
        return;
      }
      btn.disabled = true;
      btn.style.opacity = "0.6";
    }

    function editarFila(btn) {
      const fila = btn.closest("tr");
      fila.querySelector("td").focus();
    }

    function eliminarFila(btn) {
      btn.closest("tr").remove();
      calcularPromedio();
    }

    function calcularPromedio() {
      const celdas = [...document.querySelectorAll("#tablaCalificaciones tbody td:nth-child(2)")];
      const notas = celdas.map(td => parseInt(td.textContent)).filter(n => !isNaN(n));
      if (notas.length === 0) { promedioGrupo.textContent = "-"; return; }
      const prom = (notas.reduce((a,b)=>a+b,0)/notas.length).toFixed(1);
      promedioGrupo.textContent = prom;
    }

    function guardarCalificaciones() {
      const trimestre = document.getElementById("trimestre").value;
      const materia = document.getElementById("materia").value;
      const grupo = document.getElementById("grupo").value;
      const docente = document.getElementById("docente").value.trim();

      if (!trimestre || !materia || !grupo || !docente) {
        alert("‚ö†Ô∏è Complete todos los campos antes de guardar.");
        return;
      }

      const filas = [...document.querySelectorAll("#tablaCalificaciones tbody tr")];
      if (filas.length === 0) {
        alert("‚ö†Ô∏è No hay alumnos registrados.");
        return;
      }

      const datos = filas.map(f => ({
        alumno: f.cells[0].textContent.trim(),
        calificacion: parseInt(f.cells[1].textContent.trim()) || 0
      }));

      const historial = JSON.parse(localStorage.getItem("historialCalificaciones")) || [];
      historial.push({ trimestre, grupo, materia, docente, datos });
      localStorage.setItem("historialCalificaciones", JSON.stringify(historial));

      mostrarMensajeExito(`‚úÖ Calificaciones guardadas correctamente para ${materia} - ${grupo} (${trimestre}).`);
    }

    function mostrarMensajeExito(mensaje) {
      mensajeExito.textContent = mensaje;
      mensajeExito.style.display = "block";
      setTimeout(() => { mensajeExito.style.display = "none"; }, 3000);
    }

    function nuevaMateria() {
      if (!confirm("¬øDeseas agregar una nueva materia? Se limpiar√° la tabla actual.")) return;
      cuerpoTabla.innerHTML = "";
      promedioGrupo.textContent = "";
      document.getElementById("materia").selectedIndex = 0;
      mensajeExito.innerHTML = "";
    }
  </script>
</body>
</html>
