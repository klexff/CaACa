<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Calificaciones â€” Centro Educativo Integral Camino a Casa</title>

  <style>
    body {
      font-family:"Segoe UI", Arial;
      background:#eef5f1;
      margin:0;
      padding:20px;
      text-align:center;
    }

    header {
      background:linear-gradient(90deg,#25619c,#2f8c4a);
      color:#fff;
      padding:18px;
      box-shadow:0 3px 8px rgba(0,0,0,0.12);
    }

    main { max-width:1100px; margin:16px auto; text-align:left; }

    table {
      width:100%;
      border-collapse:collapse;
      background:#fff;
      border-radius:10px;
      overflow:hidden;
      box-shadow:0 2px 6px rgba(0,0,0,0.08);
    }

    th,td {
      border:1px solid #ddd;
      padding:8px;
      text-align:center;
    }

    th {
      background:#25619c;
      color:#fff;
    }

    input, select {
      padding:6px;
      border-radius:6px;
      border:1px solid #ccc;
    }

    .agregar {
      background:#2f8c4a;
      color:#fff;
      padding:8px 12px;
      border-radius:8px;
      border:none;
      cursor:pointer;
      font-weight:600;
    }

    .guardar {
      background:#25619c;
      color:#fff;
      padding:8px 12px;
      border-radius:8px;
      border:none;
      cursor:pointer;
      font-weight:600;
    }

    .salir {
      background:#c0392b;
      color:#fff;
      padding:8px 12px;
      border-radius:8px;
      border:none;
      cursor:pointer;
      font-weight:600;
    }

    .editar {
      background:#ffc107;
      color:#000;
      border:none;
      padding:6px 8px;
      border-radius:6px;
      cursor:pointer;
    }

    .eliminar {
      background:#c0392b;
      color:#fff;
      border:none;
      padding:6px 8px;
      border-radius:6px;
      cursor:pointer;
    }

    .rojo{background:#f8d7da;}
    .amarillo{background:#fff3cd;}
    .verde{background:#d4edda;}

    .mensajeExito {
      background:#d4edda;
      border:1px solid #c3e6cb;
      color:#155724;
      padding:10px;
      border-radius:8px;
      margin-top:12px;
      display:none;
      text-align:center;
      font-weight:600;
    }

    label { font-weight:700; margin-right:8px; }

    /* ğŸ“Œ Mantengo la distribuciÃ³n solicitada antes (botones distribuidos) */
    .controles {
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      justify-content:space-between;
      align-items:center;
      margin-bottom:10px;
    }

    .controles > * {
      flex:1;
      min-width:150px;
    }

    .btn-nueva-materia {
      margin-left: auto;
    }

  </style>
</head>

<body>

<header><h1>ğŸ“ Registro de Calificaciones</h1></header>

<main>

  <div id="alertaTrimestre" style="padding:10px; background:#fff3cd; border-radius:8px; margin-bottom:12px;">
    Cargando informaciÃ³n de trimestres...
  </div>

  <!-- Controles superiores -->
  <div class="controles">

    <div>
      <label>Trimestre:</label>
      <select id="trimestre"></select>
    </div>

    <div>
      <label>Grupo:</label>
      <select id="grupo">
        <option value="">Seleccione...</option>
        <option value="1Â°">1Â°</option>
        <option value="2Â°">2Â°</option>
        <option value="3Â°">3Â°</option>
      </select>
    </div>

    <div>
      <label>Materia:</label>
      <select id="materia"><option>Seleccione...</option></select>
    </div>

    <div>
      <label>Docente:</label>
      <input id="docente" placeholder="Nombre del docente" />
    </div>

    <!-- BOTÃ“N AGREGAR ALUMNO REMOVIDO -->

    <button id="btnGuardar" class="guardar">Guardar</button>

    <button id="btnNuevoMateria" class="agregar btn-nueva-materia">Nueva Materia</button>

    <button id="btnSalir" class="salir">Salir</button>

  </div>

  <table id="tablaCalificaciones">
    <thead>
      <tr><th>Alumno</th><th>CalificaciÃ³n</th><th>Acciones</th></tr>
    </thead>
    <tbody></tbody>
    <tfoot>
      <tr><th>Promedio del grupo</th><th id="promedioGrupo">-</th><th></th></tr>
    </tfoot>
  </table>

  <div id="mensajeExito" class="mensajeExito"></div>

</main>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
  import { getDatabase, ref, set, get } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDqty2eG_5VEi5NtU_HQzfZU_6FruMh66Q",
    authDomain: "camino-a-casa-87d65.firebaseapp.com",
    databaseURL: "https://camino-a-casa-87d65-default-rtdb.firebaseio.com",
    projectId: "camino-a-casa-87d65",
    storageBucket: "camino-a-casa-87d65.firebasestorage.app",
    messagingSenderId: "725645453280",
    appId: "1:725645453280:web:4cc41935020d1ae290ed85"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  // Materias por grupo
  const materiasPorGrupo = {
    "1Â°": ["MatemÃ¡ticas 1","EspaÃ±ol 1","BiologÃ­a 1","GeografÃ­a 1","Danza 1","EducaciÃ³n FÃ­sica 1","Historia I","Ã‰tica I","InglÃ©s 1","GastronomÃ­a 1","Habilidades Digitales 1"],
    "2Â°": ["MatemÃ¡ticas 2","EspaÃ±ol 2","Danza 2","Ã‰tica II","FÃ­sica 2","InglÃ©s 2","EducaciÃ³n FÃ­sica 2","Historia II","GastronomÃ­a 2","Habilidades Digitales 2"],
    "3Â°": ["MatemÃ¡ticas 3","EspaÃ±ol 3","InglÃ©s 3","Danza 3","Ã‰tica III","Vida Saludable 3","Historia III","EducaciÃ³n FÃ­sica 3","GastronomÃ­a 3","Habilidades Digitales 3","QuÃ­mica 3"]
  };

  // Alumnos por grupo (orden alfabÃ©tico)
const alumnosPorGrupo = {
  "1Â°": [
    "Cesar D. Hernandez",
    "A. Santiago Sanchez",
    "Isabella Barragan",
    "V. Victoria Rios",
    "Samuel Tassias"
  ],

  "2Â°": [
    "Mateo A. Vazquez",
    "Mario N. Gordillo",
    "Julieta Salinas",
    "Alisson Valencia"
  ],

  "3Â°": [
    "Hector Penagos",
    "David A. Gil",
    "Damian Alcazar",
    "Ruben Solis",
    "Paulina Ruiz",
    "Grecia Morales",
    "Hiram Rodas",
    "Jesus Borbollan"
  ]
};


  const cuerpoTabla = document.querySelector("#tablaCalificaciones tbody");
  const promedioGrupo = document.getElementById("promedioGrupo");
  const mensajeExito = document.getElementById("mensajeExito");

  document.addEventListener("DOMContentLoaded", async () => {
    await cargarTrimestre();
    document.getElementById("grupo").addEventListener("change", actualizarGrupo);
    // removida la referencia al botÃ³n btnAgregar para evitar errores
    document.getElementById("btnGuardar").addEventListener("click", guardar);
    document.getElementById("btnNuevoMateria").addEventListener("click", nuevaMateria);

    // âœ… EVENTO DEL BOTÃ“N SALIR
    document.getElementById("btnSalir").addEventListener("click", () => {
      window.location.href = "index.html";
    });
  });

  async function cargarTrimestre() {
    const snap = await get(ref(db, "configuracion/trimestreActivo"));
    const select = document.getElementById("trimestre");
    const alertaTrimestre = document.getElementById("alertaTrimestre");

    if (!snap.exists()) {
      alertaTrimestre.textContent = "ğŸš« No hay trimestre activo.";
      return;
    }

    const t = snap.val();
    alertaTrimestre.innerHTML = `âœ” Trimestre activo: <b>${t.nombre}</b> (${t.inicio} al ${t.fin})`;

    const opt = document.createElement("option");
    opt.value = t.nombre;
    opt.textContent = t.nombre;
    select.appendChild(opt);
  }

  function actualizarGrupo() {
    const grupo = document.getElementById("grupo").value;
    cargarMaterias(grupo);
    cargarAlumnos(grupo);
  }

  function cargarMaterias(grupo) {
    const m = document.getElementById("materia");
    m.innerHTML = "";

    if (!grupo) return;

    materiasPorGrupo[grupo]?.forEach(mat => {
      const op = document.createElement("option");
      op.value = mat;
      op.textContent = mat;
      m.appendChild(op);
    });
  }

  function cargarAlumnos(grupo) {
    cuerpoTabla.innerHTML="";
    promedioGrupo.textContent="-";

    if (!grupo) return;

    alumnosPorGrupo[grupo].forEach(a=>{
      const tr=document.createElement("tr");
      tr.innerHTML=`
        <td contenteditable="true">${a}</td>
        <td contenteditable="true" onblur="validarCalificacion(this)"></td>
        <td>
          <button class="editar" onclick="editarFila(this)">âœï¸</button>
          <button class="eliminar" onclick="eliminarFila(this)">ğŸ—‘ï¸</button>
        </td>
      `;
      cuerpoTabla.appendChild(tr);
    });
  }

  // FUNCIÃ“N NUEVA MATERIA
  function nuevaMateria() {
    if (!confirm("Â¿Deseas iniciar captura para una nueva materia?")) return;
    cuerpoTabla.innerHTML = "";
    promedioGrupo.textContent = "-";
    document.getElementById("materia").selectedIndex = 0;
    mensajeExito.style.display = "none";
  }

  window.validarCalificacion = function(td){
    let v=td.textContent.trim();
    if (!/^\d+$/.test(v)) { td.textContent=""; return; }
    v=parseInt(v,10);
    if (v<6 || v>10){ td.textContent=""; return; }
    aplicarColor(td,v);
    calcularPromedio();
  };

  function aplicarColor(td,v){
    td.className="";
    if (v<7) td.classList.add("rojo");
    else if (v<=8) td.classList.add("amarillo");
    else td.classList.add("verde");
  }

  window.editarFila = b => b.closest("tr").querySelector("td").focus();
  window.eliminarFila = b => { b.closest("tr").remove(); calcularPromedio(); };

  function agregarFila(){
    const tr=document.createElement("tr");
    tr.innerHTML=`
      <td contenteditable="true"></td>
      <td contenteditable="true" onblur="validarCalificacion(this)"></td>
      <td>
        <button class="editar" onclick="editarFila(this)">âœï¸</button>
        <button class="eliminar" onclick="eliminarFila(this)">ğŸ—‘ï¸</button>
      </td>`;
    cuerpoTabla.appendChild(tr);
  }

  function calcularPromedio(){
    const notas=[...document.querySelectorAll("#tablaCalificaciones tbody td:nth-child(2)")]
      .map(td=>parseInt(td.textContent))
      .filter(n=>!isNaN(n));

    if (notas.length===0) return promedioGrupo.textContent="-";

    const pr=(notas.reduce((a,b)=>a+b,0)/notas.length).toFixed(1);
    promedioGrupo.textContent=pr;
  }

  async function guardar(){
    const trimestre=document.getElementById("trimestre").value;
    const grupo=document.getElementById("grupo").value;
    const materia=document.getElementById("materia").value;
    const docente=document.getElementById("docente").value.trim();

    if(!trimestre||!grupo||!materia||!docente){
      alert("Complete todos los campos.");
      return;
    }

    const filas=[...document.querySelectorAll("#tablaCalificaciones tbody tr")];
    const datos=filas.map(f=>({
      alumno:f.cells[0].textContent.trim(),
      calificacion:parseInt(f.cells[1].textContent.trim())||null
    }));

    for(const d of datos){
      if(!d.alumno || d.calificacion===null){
        alert("Complete todos los datos.");
        return;
      }
    }

    const path=`calificaciones/${encode(trimestre)}/${encode(grupo)}/${encode(materia)}`;

    await set(ref(db,path),{
      docente,
      datos,
      savedAt:new Date().toISOString()
    });

    mensajeExito.style.display="block";
    mensajeExito.textContent=`âœ” Calificaciones guardadas correctamente`;
    setTimeout(()=> mensajeExito.style.display="none", 3500);
  }

  function encode(s){ return s.replace(/\./g,"_"); }

</script>

</body>
</html>
